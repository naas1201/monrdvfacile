<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title data-fr="Modifier un Événement - MonRdvFacile" data-en="Edit Event - MyEasyMeeting">Modifier un Événement - MonRdvFacile</title>
    <meta name="description" content="Page de modification d'événements pour MonRdvFacile. Mettez à jour les détails de votre événement et gérez les inscriptions.">
    <meta name="robots" content="noindex, nofollow">
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-K2JVSXZXNN"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-K2JVSXZXNN');
    </script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <style>
        /* --- Inline CSS for edit-event.html (Combined & Extended for new features) --- */
        :root {
            --primary-color-form: #005A9C;
            --primary-darker-form: #004170;
            --secondary-color-form: #17a2b8;
            --success-color-form: #28a745;
            --danger-color-form: #dc3545;
            --text-color-form: #343A40;
            --text-light-form: #6C757D;
            --bg-color-form: #F8F9FA;
            --content-bg-form: #FFFFFF;
            --border-color-form: #CED4DA;
            --border-radius-form: 8px;
            --box-shadow-form: 0 4px 15px rgba(0, 0, 0, 0.08);
        }

        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html { font-size: 16px; scroll-behavior: smooth; -webkit-text-size-adjust: 100%; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            line-height: 1.65; background-color: var(--bg-color-form); color: var(--text-color-form);
            display: flex; flex-direction: column; min-height: 100vh;
            -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
        }
        h1, h2, h3, h4, h5, h6 { font-weight: 600; color: var(--primary-darker-form); margin-bottom: 0.85rem; line-height: 1.3; }
        h1.main-title { font-size: 2.4rem; margin-top: 1.2rem; text-align: center; margin-bottom: 2rem; color: var(--primary-color-form); }
        h2#loadedEventNameDisplay {text-align:center; color: var(--primary-color-form); margin-bottom:1.5rem; font-size:1.8rem;}
        legend { font-size: 1.3rem; font-weight: 600; color: var(--primary-color-form); padding: 0 10px; margin-left: 5px; margin-bottom: 1rem; border-bottom: 2px solid var(--primary-color-form); display: inline-block;}
        p { margin-bottom: 1rem; }
        a { color: var(--primary-color-form); text-decoration: none; transition: color 0.2s ease-in-out; }
        a:hover, a:focus { color: var(--primary-darker-form); text-decoration: underline; }
        .container { width: 90%; max-width: 1200px; margin-left: auto; margin-right: auto; padding: 20px 15px; }
        main.container { flex-grow: 1; }
        
        #app-header { /* Styles from hf.js */ }
        #app-footer { margin-top: auto; /* Styles from hf.js */ }

        .lang-toggle { text-align: right; margin-bottom: 1.5rem; font-size: 0.9rem; }
        .lang-link { color: var(--text-light-form); text-decoration: none; padding: 0.3rem 0.5rem; border-radius: 4px; cursor:pointer; font-weight: 500; }
        .lang-link.active { font-weight: bold; color: var(--primary-color-form); background-color: rgba(0, 90, 156, 0.1); }
        .lang-link:hover { background-color: rgba(0, 90, 156, 0.07); }

        .section-container { background-color: var(--content-bg-form); padding: 30px 35px; border-radius: var(--border-radius-form); box-shadow: var(--box-shadow-form); margin-top: 20px; margin-bottom: 30px; }
        fieldset { border: 1px solid #e0e0e0; padding: 25px; margin-bottom: 30px; border-radius: var(--border-radius-form); background-color: #fdfdfd; }
        .form-group { margin-bottom: 1.5rem; }
        .form-group-inline { display: flex; flex-wrap: wrap; gap: 25px; margin-bottom: 1.5rem; }
        .form-group-inline .form-group { flex: 1; min-width: 220px; margin-bottom: 0; }
        label { display: block; font-weight: 500; color: var(--text-color-form); margin-bottom: 0.6rem; font-size: 1.05rem; }
        input[type="text"], input[type="url"], input[type="password"], input[type="date"], input[type="time"], input[type="number"], textarea, select {
            width: 100%; padding: 0.8rem 1.1rem; font-size: 1rem; line-height: 1.5; color: #495057;
            background-color: var(--content-bg-form); border: 1px solid var(--border-color-form); border-radius: 6px;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.06);
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }
        input[type="date"], input[type="time"] { min-height: calc(1.5em + 1.6rem + 2px); }
        textarea { resize: vertical; min-height: 100px; }
        select {
            appearance: none; -webkit-appearance: none; -moz-appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23005A9C%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat; background-position: right 1rem center; background-size: 0.8em; padding-right: 2.5rem;
        }
        select::-ms-expand { display: none; }
        input:focus, textarea:focus, select:focus {
            border-color: var(--primary-color-form); outline: 0; box-shadow: 0 0 0 0.25rem rgba(0, 90, 156, 0.2);
        }
        input.form-error, textarea.form-error, select.form-error { border-color: var(--danger-color-form) !important; }
        ::placeholder { color: #868e96; opacity: 1; }
        .form-group-checkbox, .form-group-radio { display: flex; align-items: center; gap: 0.6rem; margin-bottom: 0.7rem; }
        .form-group-checkbox input[type="checkbox"], .form-group-radio input[type="radio"] { width: auto; margin-right: 8px; transform: scale(1.35); accent-color: var(--primary-color-form); cursor:pointer; }
        .form-group-checkbox label, .form-group-radio label { margin-bottom: 0; font-weight: normal; cursor:pointer; font-size: 1rem;}
        small, .form-text { display: block; margin-top: 0.4rem; font-size: 0.9rem; color: var(--text-light-form); }
        .form-error-text { display: block; margin-top: 0.4rem; font-size: 0.9rem; color: var(--danger-color-form); min-height: 1.2em; font-weight:500;}
        
        .form-actions { margin-top: 2.5rem; padding-top: 2rem; border-top: 1px solid #e9ecef; display: flex; flex-wrap: wrap; gap: 1rem; justify-content: flex-end; }
        .btn {
            display: inline-flex; align-items:center; justify-content:center; gap: 0.6rem;
            font-weight: 500; color: #FFFFFF; text-align: center; vertical-align: middle;
            cursor: pointer; user-select: none; border: 1px solid transparent;
            padding: 0.8rem 1.5rem; font-size: 1.05rem; line-height: 1.5; border-radius: 6px;
            transition: all 0.2s ease-in-out;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .btn-primary { background-color: var(--primary-color-form); border-color: var(--primary-color-form); }
        .btn-primary:hover { background-color: var(--primary-darker-form); border-color: var(--primary-darker-form); }
        .btn-secondary { background-color: #6C757D; border-color: #6C757D }
        .btn-secondary:hover { background-color: #5A6268; border-color: #545B62; }
        .btn-danger {background-color: var(--danger-color-form); border-color: var(--danger-color-form);}
        .btn-danger:hover {background-color: #c82333; border-color: #bd2130;}
        .btn-info { background-color: var(--secondary-color-form); border-color: var(--secondary-color-form); color: white; }
        .btn-info:hover { background-color: #117A8B; border-color: #10707F;}
        .btn-sm { padding: 0.3rem 0.7rem; font-size: 0.9rem; border-radius: 4px; }

        .form-message { padding: 15px 20px; margin-bottom: 25px; border-radius: var(--border-radius-form); border: 1px solid transparent; font-size: 1.05rem; display: none; line-height: 1.6; text-align:left; }
        .form-message-error { color: #721C24; background-color: #F8D7DA; border-color: #F5C6CB; }
        .form-message-success { color: #155724; background-color: #D4EDDA; border-color: #C3E6CB; }
        .form-message-info { color: #0C5460; background-color: #D1ECF1; border-color: #BEE5EB; }
        
        .menu-builder-container .menu-section {
            border: 1px solid #e0e0e0; padding: 20px; margin-bottom: 20px; border-radius: var(--border-radius-form); background-color: #f9fcff;
        }
        .menu-section h4 { font-size: 1.15rem; color: var(--primary-darker-form); margin-bottom: 15px; display:flex; justify-content:space-between; align-items:center; padding-bottom:10px; border-bottom:1px solid #eee;}
        .menu-section h4 label {margin-bottom:0; flex-grow:1;}
        .menu-items-container .menu-item-group { display: flex; gap: 10px; margin-bottom: 10px; align-items: center;}
        .menu-items-container .menu-item-group input[type="text"] { flex-grow: 1; }
        .menu-items-container .menu-item-group input[type="number"] { width: 100px; flex-shrink:0; }
        .btn-add-item, .btn-remove-item, .btn-remove-section { padding: 0.5rem 0.9rem; font-size:0.9rem; line-height:1; }
        #addMenuSectionBtnEdit { margin-top:15px; background-color: var(--success-color-form); }
        #addMenuSectionBtnEdit:hover { background-color: #218838; }

        .location-type-specific { display: none; padding-top:15px; border-top: 1px dashed #e0e0e0; margin-top:15px;}
        .location-type-specific.active { display: block; }

        /* Dashboard Styles (from previous version) */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom:20px; }
        .dashboard-card { background-color: #fff; padding: 20px; border-radius: 6px; box-shadow: 0 2px 8px rgba(0,0,0,0.07); }
        .dashboard-card h4 { font-size: 1.1rem; color: #004170; margin-top:0; margin-bottom:10px; }
        .progress-bar-container { background-color: #e9ecef; border-radius: .25rem; height: 20px; overflow: hidden; margin-bottom: 5px; }
        .progress-bar { background-color: var(--primary-color-form); height: 100%; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.8rem; transition: width 0.6s ease; }
        .stat-value { font-size: 1.8rem; font-weight: bold; color: var(--primary-darker-form); }
        .stat-label { font-size: 0.9rem; color: var(--text-light-form); }
        #tableVisualization { display: flex; flex-wrap: wrap; gap: 20px; padding:10px; border: 1px solid #eee; border-radius:5px; background:#fdfdfd; margin-top:15px;}
        .event-table { border: 2px solid var(--primary-color-form); border-radius: 5px; padding: 10px; background-color: #f0f8ff; }
        .event-table-title { font-weight: bold; margin-bottom: 8px; text-align:center; font-size:0.9rem; color: var(--primary-darker-form);}
        .seats-grid { display: grid; gap: 5px; }
        .seat { width: 30px; height: 30px; border-radius: 3px; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; color: white; cursor: default; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .seat.available { background-color: var(--success-color-form); }
        .seat.booked { background-color: var(--danger-color-form); }
        .seat.booked:hover { transform: scale(1.1); box-shadow: 0 0 8px rgba(0,0,0,0.3); z-index:10; }
        .seat-tooltip { visibility: hidden; background-color: #333; color: #fff; text-align: center; border-radius: 4px; padding: 5px 8px; position: absolute; z-index: 100; font-size: 0.8rem; white-space: nowrap; bottom: 125%; left: 50%; transform: translateX(-50%); opacity: 0; transition: opacity 0.3s; }
        .seat.booked:hover .seat-tooltip { visibility: visible; opacity: 1; }
        .attendee-table-container { overflow-x: auto; margin-top:15px; }
        .attendee-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        .attendee-table th, .attendee-table td { border: 1px solid #dee2e6; padding: 8px 10px; text-align: left; }
        .attendee-table th { background-color: #e9ecef; color: var(--primary-darker-form); font-weight: 600; }
        .attendee-table tbody tr:nth-child(odd) { background-color: #f8f9fa; }
        .attendee-table tbody tr:hover { background-color: #e2e6ea; }
        .fa-spinner { animation: fa-spin 1s infinite linear; }
        @keyframes fa-spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        @media (max-width: 768px) { /* ... (Keep existing responsive styles) ... */ }
        @media (max-width: 480px) { /* ... (Keep existing responsive styles) ... */ }
    </style>
</head>
<body>

    <div id="app-header"></div>

    <main class="container">
        <h1 class="main-title" data-fr="Modifier un Événement" data-en="Edit Event">Modifier un Événement</h1>
        <p class="lang-toggle">
            <a href="#" onclick="inlineChangeLangEdit('fr'); return false;" class="lang-link active" id="lang-fr-edit">FR</a> |
            <a href="#" onclick="inlineChangeLangEdit('en'); return false;" class="lang-link" id="lang-en-edit">EN</a>
        </p>

        <div id="formGeneralMessageInline" class="form-message" role="alert"></div>

        <section id="authSection" class="section-container">
            <h2 data-fr="Authentification Requise" data-en="Authentication Required">Authentification Requise</h2>
            <form id="authEventForm">
                <div class="form-group">
                    <label for="authEventId" data-fr="ID de l'Événement :" data-en="Event ID:">ID de l'Événement :</label>
                    <input type="text" id="authEventId" name="authEventId" required>
                    <small class="form-error-text" id="authEventIdError"></small>
                </div>
                <div class="form-group">
                    <label for="authAdminPassword" data-fr="Mot de passe Administrateur :" data-en="Admin Password:">Mot de passe Administrateur :</label>
                    <input type="password" id="authAdminPassword" name="authAdminPassword" required>
                    <small class="form-error-text" id="authAdminPasswordError"></small>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary"><i class="fas fa-sign-in-alt"></i> <span data-fr="Charger l'Événement" data-en="Load Event">Charger</span></button>
                </div>
            </form>
        </section>

        <div id="eventDashboardAndEditSection" style="display:none;">
            <h2 id="loadedEventNameDisplay"></h2>

            <section id="eventDashboardSection" class="section-container">
                <h3 data-fr="Tableau de Bord de l'Événement" data-en="Event Dashboard">Tableau de Bord</h3>
                <div class="dashboard-grid">
                    <div class="dashboard-card">
                        <h4 data-fr="Statistiques Générales" data-en="Overall Statistics">Statistiques Générales</h4>
                        <p><span class="stat-label" data-fr="Capacité Totale :" data-en="Total Capacity:">Capacité Totale :</span> <span id="totalCapacity" class="stat-value">0</span></p>
                        <p><span class="stat-label" data-fr="Inscrits :" data-en="Registered:">Inscrits :</span> <span id="totalRegistered" class="stat-value">0</span></p>
                        <p><span class="stat-label" data-fr="Places Restantes :" data-en="Seats Remaining:">Places Restantes :</span> <span id="seatsRemaining" class="stat-value">0</span></p>
                        <div class="progress-bar-container"><div class="progress-bar" id="capacityProgressBar" style="width: 0%;"><span id="capacityPercentage">0%</span></div></div>
                    </div>
                    <div class="dashboard-card">
                        <h4 data-fr="Répartition des Menus Choisis" data-en="Chosen Menu Breakdown">Répartition des Menus</h4>
                        <div id="menuStatsContainer"><p data-fr="Aucune donnée de menu." data-en="No menu data.">Aucune donnée.</p></div>
                    </div>
                    <div class="dashboard-card" id="paymentStatsCardEdit" style="display:none;">
                        <h4 data-fr="Statistiques de Paiement" data-en="Payment Statistics">Paiements</h4>
                        <p><span class="stat-label" data-fr="'Payé' :" data-en="'Paid':">Payé :</span> <span id="countPaidYesEdit" class="stat-value">0</span></p>
                        <p><span class="stat-label" data-fr="'Non Payé' :" data-en="'Not Paid':">Non Payé :</span> <span id="countPaidNoEdit" class="stat-value">0</span></p>
                    </div>
                </div>
                <div>
                    <h4 data-fr="Visualisation des Tables et Sièges" data-en="Table & Seat Visualization" style="margin-top:20px;">Visualisation des Tables</h4>
                    <div id="tableVisualization"><p data-fr="Chargez un événement." data-en="Load an event.">Chargez un événement.</p></div>
                </div>
            </section>

            <section id="editEventFormSection" class="section-container">
                <h3 data-fr="Modifier les Détails de l'Événement" data-en="Edit Event Details">Modifier les Détails</h3>
                <form id="editEventForm" novalidate>
                    <input type="hidden" id="editingEventId" name="editingEventId">
                    <fieldset>
                        <legend data-fr="Informations Générales" data-en="General Information">Informations Générales</legend>
                        <div class="form-group">
                            <label for="eventNameEdit" data-fr="Nom de l'événement :" data-en="Event Name:">Nom de l'événement :</label>
                            <input type="text" id="eventNameEdit" name="eventName" required maxlength="100"><small class="form-error-text" id="eventNameEditError"></small>
                        </div>
                        <div class="form-group">
                            <label for="organizerNameEdit" data-fr="Nom de l'organisateur (optionnel) :" data-en="Organizer Name (optional):">Nom de l'organisateur :</label>
                            <input type="text" id="organizerNameEdit" name="organizerName" maxlength="100"><small class="form-error-text" id="organizerNameEditError"></small>
                        </div>
                        <div class="form-group">
                            <label for="eventDescriptionEdit" data-fr="Description :" data-en="Description:">Description :</label>
                            <textarea id="eventDescriptionEdit" name="eventDescription" rows="4" maxlength="500" required></textarea>
                            <small id="charCountEdit" class="form-text"></small><small class="form-error-text" id="eventDescriptionEditError"></small>
                        </div>
                    </fieldset>

                    <fieldset>
                        <legend data-fr="Date, Heure & Récurrence" data-en="Date, Time & Recurrence">Date, Heure & Récurrence</legend>
                        <div class="form-group-inline">
                            <div class="form-group"><label for="eventStartDateEdit" data-fr="Date de début :" data-en="Start Date:">Date début :</label><input type="date" id="eventStartDateEdit" name="eventStartDate" required><small class="form-error-text" id="eventStartDateEditError"></small></div>
                            <div class="form-group"><label for="eventStartTimeEdit" data-fr="Heure début (optionnel) :" data-en="Start Time (optional):">Heure début :</label><input type="time" id="eventStartTimeEdit" name="eventStartTime"><small class="form-error-text" id="eventStartTimeEditError"></small></div>
                        </div>
                        <div class="form-group-inline">
                            <div class="form-group"><label for="eventEndDateEdit" data-fr="Date de fin :" data-en="End Date:">Date fin :</label><input type="date" id="eventEndDateEdit" name="eventEndDate" required><small class="form-error-text" id="eventEndDateEditError"></small></div>
                            <div class="form-group"><label for="eventEndTimeEdit" data-fr="Heure fin (optionnel) :" data-en="End Time (optional):">Heure fin :</label><input type="time" id="eventEndTimeEdit" name="eventEndTime"><small class="form-error-text" id="eventEndTimeEditError"></small></div>
                        </div>
                        <div class="form-group-inline">
                            <div class="form-group"><label for="registrationDeadlineDateEdit" data-fr="Date limite inscription :" data-en="Reg. Deadline Date:">Date limite inscription :</label><input type="date" id="registrationDeadlineDateEdit" name="registrationDeadlineDate" required><small class="form-error-text" id="registrationDeadlineDateEditError"></small></div>
                            <div class="form-group"><label for="registrationDeadlineTimeEdit" data-fr="Heure limite (optionnel) :" data-en="Deadline Time (opt.):">Heure limite :</label><input type="time" id="registrationDeadlineTimeEdit" name="registrationDeadlineTime"><small class="form-error-text" id="registrationDeadlineTimeEditError"></small></div>
                        </div>
                        <div class="form-group form-group-checkbox">
                            <input type="checkbox" id="isRecurringEventEdit" name="isRecurringEvent"><label for="isRecurringEventEdit" data-fr="Événement récurrent ?" data-en="Recurring event?">Récurrent ?</label>
                        </div>
                        <div class="form-group location-type-specific" id="recurringRuleGroupEdit">
                            <label for="recurringRuleEdit" data-fr="Règle de récurrence :" data-en="Recurrence Rule:">Règle récurrence :</label><input type="text" id="recurringRuleEdit" name="recurringRule"><small class="form-error-text" id="recurringRuleEditError"></small>
                        </div>
                    </fieldset>

                    <fieldset>
                        <legend data-fr="Lieu de l'Événement" data-en="Event Location">Lieu</legend>
                        <div class="form-group">
                            <label data-fr="Type de lieu :" data-en="Location Type:">Type :</label>
                            <div class="form-group-radio"><input type="radio" id="locationTypeOfflineEdit" name="locationType" value="offline"><label for="locationTypeOfflineEdit" data-fr="Lieu physique" data-en="Physical">Physique</label></div>
                            <div class="form-group-radio"><input type="radio" id="locationTypeOnlineEdit" name="locationType" value="online"><label for="locationTypeOnlineEdit" data-fr="En ligne" data-en="Online">En ligne</label></div>
                            <small class="form-error-text" id="locationTypeEditError"></small>
                        </div>
                        <div id="offlineLocationDetailsEdit" class="location-type-specific">
                            <div class="form-group"><label for="venueNameEdit" data-fr="Nom du lieu :" data-en="Venue Name:">Nom lieu :</label><input type="text" id="venueNameEdit" name="venueName" maxlength="150"><small class="form-error-text" id="venueNameEditError"></small></div>
                            <div class="form-group"><label for="eventLocationAddressEdit" data-fr="Adresse :" data-en="Address:">Adresse :</label><textarea id="eventLocationAddressEdit" name="eventLocationAddress" rows="3"></textarea><small class="form-error-text" id="eventLocationAddressEditError"></small></div>
                            <div class="form-group"><label for="eventLocationGMapLinkEdit" data-fr="Lien Google Maps (opt.) :" data-en="Google Maps Link (opt.):">Lien G. Maps :</label><input type="url" id="eventLocationGMapLinkEdit" name="eventLocationGMapLink"><small class="form-error-text" id="eventLocationGMapLinkEditError"></small></div>
                        </div>
                        <div id="onlineLocationDetailsEdit" class="location-type-specific">
                            <div class="form-group"><label for="onlineMeetingLinkEdit" data-fr="Lien réunion en ligne :" data-en="Online Meeting Link:">Lien réunion :</label><input type="url" id="onlineMeetingLinkEdit" name="onlineMeetingLink"><small class="form-error-text" id="onlineMeetingLinkEditError"></small></div>
                        </div>
                    </fieldset>

                    <fieldset>
                        <legend data-fr="Configuration Salle & Participation" data-en="Venue & Participation Setup">Salle & Participation</legend>
                        <div class="form-group-inline">
                            <div class="form-group"><label for="numTablesEdit" data-fr="Nb. Tables (0 si N/A) :" data-en="Tables (0 if N/A):">Nb. Tables :</label><input type="number" id="numTablesEdit" name="numTables" min="0" required><small class="form-error-text" id="numTablesEditError"></small></div>
                            <div class="form-group"><label for="chairsPerTableEdit" data-fr="Chaises/Table (0 si N/A) :" data-en="Chairs/Table (0 if N/A):">Chaises/Table :</label><input type="number" id="chairsPerTableEdit" name="chairsPerTable" min="0" max="50" required><small class="form-error-text" id="chairsPerTableEditError"></small></div>
                        </div>
                        <div class="form-group form-group-checkbox"><input type="checkbox" id="allowSeatSelectionEdit" name="allowSeatSelection"><label for="allowSeatSelectionEdit" data-fr="Permettre choix de siège ?" data-en="Allow seat selection?">Choix de siège ?</label></div>
                        <div class="form-group"><label for="maxRegistrationsPerUserEdit" data-fr="Inscriptions max/utilisateur (0=illimité) :" data-en="Max regs/user (0=unlimited):">Inscriptions max/util. :</label><input type="number" id="maxRegistrationsPerUserEdit" name="maxRegistrationsPerUser" min="0" required><small class="form-error-text" id="maxRegistrationsPerUserEditError"></small></div>
                        <div class="form-group form-group-checkbox"><input type="checkbox" id="enableWaitlistEdit" name="enableWaitlist"><label for="enableWaitlistEdit" data-fr="Activer liste d'attente ?" data-en="Enable waitlist?">Liste d'attente ?</label></div>
                    </fieldset>

                    <fieldset>
                        <legend data-fr="Menu Détaillé (Optionnel)" data-en="Detailed Menu (Optional)">Menu Détaillé</legend>
                        <div id="menuBuilderContainerEdit" class="menu-builder-container"></div>
                        <button type="button" id="addMenuSectionBtnEdit" class="btn btn-secondary btn-sm"><i class="fas fa-plus"></i> <span data-fr="Ajouter Section Menu" data-en="Add Menu Section">Ajouter Section</span></button>
                    </fieldset>

                    <fieldset>
                        <legend data-fr="Tarification & Apparence" data-en="Pricing & Appearance">Tarification & Apparence</legend>
                        <div class="form-group form-group-checkbox"><input type="checkbox" id="isPaidEventEdit" name="isPaidEvent"><label for="isPaidEventEdit" data-fr="Événement payant ?" data-en="Paid event?">Payant ?</label></div>
                        <div class="form-group" id="eventPriceGroupEdit" style="display: none;"><label for="eventPriceEdit" data-fr="Prix (€) :" data-en="Price (€):">Prix (€) :</label><input type="number" id="eventPriceEdit" name="eventPrice" min="0" step="0.01"><small class="form-error-text" id="eventPriceEditError"></small></div>
                        <div class="form-group">
                            <label for="eventBadgeEdit" data-fr="Badge principal :" data-en="Main badge:">Badge :</label>
                            <select id="eventBadgeEdit" name="eventBadge">
                                <option value="none" data-fr="Aucun" data-en="None">Aucun</option><option value="new" data-fr="Nouveau" data-en="New">Nouveau</option><option value="popular" data-fr="Populaire" data-en="Popular">Populaire</option><option value="special" data-fr="Spécial" data-en="Special">Spécial</option><option value="promo" data-fr="Promotion" data-en="Promotion">Promotion</option><option value="soon" data-fr="Bientôt Complet" data-en="Nearly Full">Bientôt Complet</option><option value="afa" data-fr="Badge AFA" data-en="AFA Badge">AFA</option>
                            </select>
                        </div>
                    </fieldset>
                    
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> <span data-fr="Sauvegarder" data-en="Save Changes">Sauvegarder</span></button>
                        <button type="button" id="deleteEventButton" class="btn btn-danger"><i class="fas fa-trash-alt"></i> <span data-fr="Supprimer" data-en="Delete">Supprimer</span></button>
                        <button type="button" id="cancelEditButton" class="btn btn-secondary"><i class="fas fa-times"></i> <span data-fr="Annuler" data-en="Cancel">Annuler</span></button>
                    </div>
                </form>
            </section>

            <section id="attendeeManagementSection" class="section-container">
                <h3 data-fr="Gestion des Inscriptions" data-en="Attendee Management">Inscriptions</h3>
                <button id="exportCsvButton" class="btn btn-info" style="margin-bottom: 15px;"><i class="fas fa-file-csv"></i> <span data-fr="Exporter CSV" data-en="Export CSV">Exporter CSV</span></button>
                <div class="attendee-table-container">
                    <table class="attendee-table">
                        <thead><tr><th data-fr="Nom" data-en="Name">Nom</th><th data-fr="Email" data-en="Email">Email</th><th data-fr="Téléphone" data-en="Phone">Téléphone</th><th data-fr="Menu" data-en="Menu">Menu</th><th data-fr="Date Inscription" data-en="Reg. Date">Date Inscription</th><th data-fr="Payé ?" data-en="Paid?">Payé ?</th></tr></thead>
                        <tbody id="attendeeListBody"><tr><td colspan="6" data-fr="Aucun inscrit." data-en="No attendees.">Aucun inscrit.</td></tr></tbody>
                    </table>
                </div>
            </section>

            <section id="waitlistManagementSection" class="section-container" style="display:none;">
                <h3 data-fr="Liste d'Attente" data-en="Waitlist">Liste d'Attente</h3>
                <p><span data-fr="Personnes en attente :" data-en="People on waitlist:">En attente :</span> <strong id="waitlistCount">0</strong></p>
                <div class="attendee-table-container">
                     <table class="attendee-table">
                        <thead><tr><th data-fr="Nom" data-en="Name">Nom</th><th data-fr="Email" data-en="Email">Email</th><th data-fr="Téléphone" data-en="Phone">Téléphone</th><th data-fr="Date Ajout" data-en="Date Added">Date Ajout</th></tr></thead>
                        <tbody id="waitlistBody"><tr><td colspan="4" data-fr="Liste d'attente vide." data-en="Waitlist empty.">Vide.</td></tr></tbody>
                    </table>
                </div>
            </section>
        </div>
    </main>

    <div id="app-footer"></div>

    <script src="src/hf.js"></script>
    <script>
    // --- MonRdvFacile - Inline JS for edit-event.html (Enhanced Features & Optional Time) ---
    document.addEventListener('DOMContentLoaded', function() {
        const WORKER_BASE_URL = 'https://monrdvfacile-api.qmpro.workers.dev/api/events';
        let currentAuthenticatedPassword = null;
        let currentlyEditingEventId = null;
        let currentLoadedEventFullData = null; // Stores { eventDetails: {...}, registrations: [...], waitlist: [...] }

        let currentLangEdit = 'fr';
        const translatableItemsEdit = [];

        // --- UI Elements Cache ---
        const uiEdit = {
            authSection: document.getElementById('authSection'),
            eventDashboardAndEditSection: document.getElementById('eventDashboardAndEditSection'),
            authEventForm: document.getElementById('authEventForm'),
            editEventForm: document.getElementById('editEventForm'),
            messageDivInline: document.getElementById('formGeneralMessageInline'),
            loadedEventNameDisplay: document.getElementById('loadedEventNameDisplay'),
            // Edit Form Fields
            editingEventIdInput: document.getElementById('editingEventId'),
            eventNameEdit: document.getElementById('eventNameEdit'),
            organizerNameEdit: document.getElementById('organizerNameEdit'),
            eventDescriptionTextareaEdit: document.getElementById('eventDescriptionEdit'),
            charCountDisplayEdit: document.getElementById('charCountEdit'),
            eventStartDateEdit: document.getElementById('eventStartDateEdit'),
            eventStartTimeEdit: document.getElementById('eventStartTimeEdit'),
            eventEndDateEdit: document.getElementById('eventEndDateEdit'),
            eventEndTimeEdit: document.getElementById('eventEndTimeEdit'),
            registrationDeadlineDateEdit: document.getElementById('registrationDeadlineDateEdit'),
            registrationDeadlineTimeEdit: document.getElementById('registrationDeadlineTimeEdit'),
            isRecurringEventCheckboxEdit: document.getElementById('isRecurringEventEdit'),
            recurringRuleGroupEdit: document.getElementById('recurringRuleGroupEdit'),
            recurringRuleInputEdit: document.getElementById('recurringRuleEdit'),
            locationTypeOfflineRadioEdit: document.getElementById('locationTypeOfflineEdit'),
            locationTypeOnlineRadioEdit: document.getElementById('locationTypeOnlineEdit'),
            offlineLocationDetailsEditDiv: document.getElementById('offlineLocationDetailsEdit'),
            onlineLocationDetailsEditDiv: document.getElementById('onlineLocationDetailsEdit'),
            venueNameEdit: document.getElementById('venueNameEdit'),
            eventLocationAddressTextareaEdit: document.getElementById('eventLocationAddressEdit'),
            eventLocationGMapLinkInputEdit: document.getElementById('eventLocationGMapLinkEdit'),
            onlineMeetingLinkInputEdit: document.getElementById('onlineMeetingLinkEdit'),
            numTablesEdit: document.getElementById('numTablesEdit'),
            chairsPerTableEdit: document.getElementById('chairsPerTableEdit'),
            allowSeatSelectionCheckboxEdit: document.getElementById('allowSeatSelectionEdit'),
            maxRegistrationsPerUserEdit: document.getElementById('maxRegistrationsPerUserEdit'),
            enableWaitlistCheckboxEdit: document.getElementById('enableWaitlistEdit'),
            menuBuilderContainerEdit: document.getElementById('menuBuilderContainerEdit'),
            addMenuSectionBtnEdit: document.getElementById('addMenuSectionBtnEdit'),
            isPaidEventCheckboxEdit: document.getElementById('isPaidEventEdit'),
            eventPriceGroupEdit: document.getElementById('eventPriceGroupEdit'),
            eventPriceInputEdit: document.getElementById('eventPriceEdit'),
            eventBadgeSelectEdit: document.getElementById('eventBadgeEdit'),
            // Dashboard Elements
            totalCapacityEl: document.getElementById('totalCapacity'),
            totalRegisteredEl: document.getElementById('totalRegistered'),
            seatsRemainingEl: document.getElementById('seatsRemaining'),
            capacityProgressBarEl: document.getElementById('capacityProgressBar'),
            capacityPercentageEl: document.getElementById('capacityPercentage'),
            menuStatsContainerEl: document.getElementById('menuStatsContainer'),
            paymentStatsCardEl: document.getElementById('paymentStatsCardEdit'),
            countPaidYesEl: document.getElementById('countPaidYesEdit'),
            countPaidNoEl: document.getElementById('countPaidNoEdit'),
            tableVisualizationEl: document.getElementById('tableVisualization'),
            attendeeListBodyEl: document.getElementById('attendeeListBody'),
            exportCsvButton: document.getElementById('exportCsvButton'),
            waitlistManagementSectionEl: document.getElementById('waitlistManagementSection'),
            waitlistCountEl: document.getElementById('waitlistCount'),
            waitlistBodyEl: document.getElementById('waitlistBody'),
            // Action Buttons
            deleteEventButton: document.getElementById('deleteEventButton'),
            cancelEditButton: document.getElementById('cancelEditButton')
        };

        // --- Language & Translation ---
        function queryTranslatableItemsEdit() {
            translatableItemsEdit.length = 0;
            document.querySelectorAll('[data-fr], [data-en], [data-fr-placeholder], [data-en-placeholder]').forEach(el => {
                const item = {
                    element: el, frText: el.dataset.fr, enText: el.dataset.en,
                    frPlaceholder: el.dataset.frPlaceholder, enPlaceholder: el.dataset.enPlaceholder,
                    isTitle: el.tagName === 'TITLE',
                    isButtonSpan: (el.tagName === 'BUTTON' || el.tagName === 'A') && el.querySelector('span:not([id])'),
                    isDirectButtonText: (el.tagName === 'BUTTON' || el.tagName === 'A') && !el.querySelector('span:not([id])') && (el.dataset.fr || el.dataset.en),
                    isInputPlaceholder: (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') && (el.dataset.frPlaceholder || el.dataset.enPlaceholder)
                };
                if (!item.frText && !item.isInputPlaceholder && !(item.isButtonSpan || item.isDirectButtonText)) item.frText = el.textContent.trim();
                if (!item.enText && !item.isInputPlaceholder && !(item.isButtonSpan || item.isDirectButtonText)) item.enText = el.textContent.trim();
                translatableItemsEdit.push(item);
            });
        }
        function updateUIForLanguageEdit(lang) {
            currentLangEdit = lang; document.documentElement.lang = lang;
            translatableItemsEdit.forEach(item => {
                const text = lang === 'fr' ? item.frText : item.enText;
                const placeholderText = lang === 'fr' ? item.frPlaceholder : item.enPlaceholder;
                if (item.isTitle) { if (text) item.element.textContent = text; }
                else if (item.isInputPlaceholder) { if (placeholderText) item.element.placeholder = placeholderText; }
                else if (item.isButtonSpan) { const span = item.element.querySelector('span:not([id])'); if (span && text) span.textContent = text; }
                else if (item.isDirectButtonText) { const icon = item.element.querySelector('i'); if (icon) item.element.innerHTML = icon.outerHTML + " " + (text || ""); else if (text) item.element.textContent = text; }
                else { if (text && typeof item.element.textContent !== 'undefined') item.element.textContent = text; }
            });
            document.querySelectorAll('.lang-link').forEach(link => link.classList.remove('active'));
            const activeLink = document.getElementById(`lang-${lang}-edit`); if (activeLink) activeLink.classList.add('active');
            try { localStorage.setItem('preferredLang', lang); } catch (e) {}
            if (currentLoadedEventFullData) {
                if (uiEdit.eventDescriptionTextareaEdit) uiEdit.eventDescriptionTextareaEdit.dispatchEvent(new Event('input'));
                if (uiEdit.menuBuilderContainerEdit) renderMenuBuilderForEdit(currentLoadedEventFullData.eventDetails.menuStructure || []);
                renderDashboard(currentLoadedEventFullData.eventDetails, currentLoadedEventFullData.registrations);
                renderAttendeeList(currentLoadedEventFullData.registrations);
                if(currentLoadedEventFullData.eventDetails.enableWaitlist) renderWaitlist(currentLoadedEventFullData.waitlist);
            }
            validateEditForm(false);
        }
        window.inlineChangeLangEdit = function(lang) { if (lang !== currentLangEdit) { queryTranslatableItemsEdit(); updateUIForLanguageEdit(lang); } };
        function detectLanguagePreferenceEdit() {
            try {const storedLang = localStorage.getItem('preferredLang'); if (storedLang && (storedLang === 'fr' || storedLang === 'en')) return storedLang;} catch (e) {}
            const browserLang = navigator.language || navigator.userLanguage; if (browserLang && browserLang.toLowerCase().startsWith('en')) return 'en'; return 'fr';
        }

        const messagesEdit = {
            eventIdRequired: { fr: "L'ID de l'événement est requis.", en: "Event ID is required." },
            passwordRequired: { fr: "Le mot de passe est requis.", en: "Password is required." },
            authError: { fr: "Authentification échouée. Vérifiez l'ID et le mot de passe.", en: "Authentication failed. Check Event ID and password."},
            eventLoaded: { fr: "Événement chargé.", en: "Event loaded." },
            changesSaved: { fr: "Modifications sauvegardées avec succès !", en: "Changes saved successfully!" },
            eventDeleted: { fr: "Événement supprimé avec succès.", en: "Event deleted successfully." },
            confirmDelete: { fr: "Êtes-vous sûr de vouloir supprimer cet événement ? Cette action est irréversible.", en: "Are you sure you want to delete this event? This action is irreversible." },
            apiError: { fr: "Erreur de communication avec le serveur.", en: "API communication error." },
            formErrors: { fr: "Veuillez corriger les erreurs en surbrillance.", en: "Please correct the highlighted errors." },
            charRemaining: { fr: "{count} caractères restants", en: "{count} characters remaining" },
            menuSectionTitleRequired: {fr: "Le titre de la section est requis.", en: "Section title is required."},
            menuItemNameRequired: {fr: "Le nom de l'élément est requis.", en: "Item name is required."},
            maxItemsPerSection: {fr: "Maximum 5 éléments par section de menu.", en: "Maximum 5 items per menu section."},
            locationTypeRequired: {fr: "Veuillez préciser le type de lieu.", en: "Please specify location type."},
            venueNameRequired: {fr: "Le nom du lieu est requis pour un événement physique.", en: "Venue name is required for a physical event."},
            addressOrGMapRequired: {fr: "Adresse ou lien Google Maps requis pour un lieu physique.", en: "Address or Google Maps link required for a physical event."},
            onlineLinkRequired: {fr: "Le lien de réunion est requis pour un événement en ligne.", en: "Meeting link is required for an online event."},
            endDateBeforeStart: { fr: "La date/heure de fin ne peut être antérieure ou égale à la date/heure de début.", en: "End date/time cannot be earlier than or same as start date/time."},
            deadlineAfterStart: { fr: "La date/heure limite d'inscription ne peut être postérieure à la date/heure de début.", en: "Registration deadline cannot be after the event start date/time."},
            deadlineTooCloseToEnd: { fr: "La date/heure limite d'inscription doit être avant la date/heure de fin.", en: "Registration deadline must be before the event end date/time."},
            invalidUrl: {fr: "URL invalide.", en: "Invalid URL."},
            required: { fr: "Ce champ est obligatoire.", en: "This field is required." },
            noAttendees: {fr: "Aucun inscrit.", en: "No attendees."},
            waitlistEmpty: {fr: "Liste d'attente vide.", en: "Waitlist empty."},
            tableLabel: {fr: "Table", en: "Table"}, seatLabel: {fr: "Siège", en: "Seat"},
            attendeeName: {fr: "Nom", en: "Name"}, attendeeEmail: {fr: "Email", en: "Email"},
            attendeeMenu: {fr: "Menu Choisi", en: "Chosen Menu"}, attendeePaid: {fr: "Payé", en: "Paid"},
            statusYes: {fr: "Oui", en: "Yes"}, statusNo: {fr: "Non", en: "No"},
            savingChanges: {fr: "Sauvegarde...", en: "Saving..."},
            deletingEvent: {fr: "Suppression...", en: "Deleting..."},
            loadingEvent: {fr: "Chargement...", en: "Loading..."},
            noDataToExport: {fr: "Aucune donnée à exporter.", en: "No data to export."},
            configureTables: {fr: "Configurez les tables pour voir la visualisation.", en: "Configure tables to see visualization."},
            noMenuData: {fr: "Aucune donnée de menu.", en: "No menu data."}
        };
        function getMessageEdit(key, replacements = {}) {
            let messageSet = messagesEdit[key]; if (!messageSet) return `Missing Edit: ${key}`;
            let message = messageSet[currentLangEdit] || messageSet['fr'] || String(key);
            for (const placeholder in replacements) { message = message.replace(`{${placeholder}}`, replacements[placeholder]); } return message;
        }
        function displayMessageInline(message, type = 'error', isHtml = false) {
            if(isHtml) uiEdit.messageDivInline.innerHTML = message; else uiEdit.messageDivInline.textContent = message;
            uiEdit.messageDivInline.className = `form-message form-message-${type}`; uiEdit.messageDivInline.style.display = 'block';
        }
        function clearMessageInline() {
            uiEdit.messageDivInline.innerHTML = ''; uiEdit.messageDivInline.style.display = 'none'; uiEdit.messageDivInline.className = 'form-message';
        }
        function clearFieldErrorsEdit() {
            for (const fieldIdKey in errorFieldMap) { // Use fieldIdKey from errorFieldMap
                const errorElId = errorFieldMap[fieldIdKey] + 'Edit'; // Construct error element ID
                const errorEl = document.getElementById(errorElId);
                if (errorEl) errorEl.textContent = '';
                
                const inputEl = document.getElementById(fieldIdKey + 'Edit'); // Construct input element ID
                if (inputEl) {inputEl.classList.remove('form-error'); inputEl.removeAttribute('aria-invalid');}
            }
            uiEdit.menuBuilderContainerEdit.querySelectorAll('.menu-section-title, .menu-item-name').forEach(el => {
                el.classList.remove('form-error'); el.removeAttribute('aria-invalid');
                const errorSmall = el.closest('.form-group')?.querySelector('.form-error-text') || el.nextElementSibling;
                if (errorSmall && errorSmall.classList.contains('form-error-text')) {
                    errorSmall.textContent = '';
                }
            });
        }
        function displayFieldErrorEdit(fieldId, messageKey, replacements = {}) {
            // fieldId here is the base name, e.g., 'eventName'
            const errorElId = errorFieldMap[fieldId] ? errorFieldMap[fieldId] + 'Edit' : fieldId + 'Error';
            const inputEl = document.getElementById(fieldId + 'Edit') || document.getElementById(fieldId); // Try with and without 'Edit'

            if (inputEl) { inputEl.classList.add('form-error'); inputEl.setAttribute('aria-invalid', 'true');}
            const errorEl = document.getElementById(errorElId);
            if (errorEl) { errorEl.textContent = getMessageEdit(messageKey, replacements); }
            else { console.warn("Error element not found for field:", fieldId, "Expected ID:", errorElId); }
        }


        if (uiEdit.eventDescriptionTextareaEdit) {
            const maxLengthEdit = parseInt(uiEdit.eventDescriptionTextareaEdit.getAttribute('maxlength'), 10);
            uiEdit.eventDescriptionTextareaEdit.addEventListener('input', function() {
                const currentLength = this.value.length; const remaining = maxLengthEdit - currentLength;
                uiEdit.charCountDisplayEdit.textContent = getMessageEdit('charRemaining', {count: remaining});
                uiEdit.charCountDisplayEdit.style.color = remaining < 0 ? 'var(--danger-color-form)' : 'var(--text-light-form)';
            });
        }

        if (uiEdit.isRecurringEventCheckboxEdit && uiEdit.recurringRuleGroupEdit) {
            uiEdit.isRecurringEventCheckboxEdit.addEventListener('change', function() {
                uiEdit.recurringRuleGroupEdit.style.display = this.checked ? 'block' : 'none';
                uiEdit.recurringRuleInputEdit.required = this.checked;
                if (!this.checked) {uiEdit.recurringRuleInputEdit.value = ''; displayFieldErrorEdit('recurringRuleEdit','');}
            });
        }

        function handleLocationTypeChangeEdit() {
            const isOnline = uiEdit.locationTypeOnlineRadioEdit.checked;
            uiEdit.onlineLocationDetailsEditDiv.classList.toggle('active', isOnline);
            uiEdit.offlineLocationDetailsEditDiv.classList.toggle('active', !isOnline);
            uiEdit.onlineMeetingLinkInputEdit.required = isOnline;
            uiEdit.venueNameEdit.required = !isOnline;
            uiEdit.eventLocationAddressTextareaEdit.required = !isOnline && !uiEdit.eventLocationGMapLinkInputEdit.value.trim();
             if(isOnline) { ['venueName', 'eventLocationAddress', 'eventLocationGMapLink'].forEach(id => { const el = document.getElementById(errorFieldMap[id] + 'Edit'); if(el) el.textContent = ''; document.getElementById(id + 'Edit')?.classList.remove('form-error'); }); }
             else { const el = document.getElementById(errorFieldMap.onlineMeetingLink + 'Edit'); if(el) el.textContent = ''; uiEdit.onlineMeetingLinkInputEdit.classList.remove('form-error');}
        }
        if (uiEdit.locationTypeOfflineRadioEdit && uiEdit.locationTypeOnlineRadioEdit) {
            [uiEdit.locationTypeOfflineRadioEdit, uiEdit.locationTypeOnlineRadioEdit].forEach(radio => radio.addEventListener('change', handleLocationTypeChangeEdit));
        }

        let menuSectionCounterEdit = 0;
        function addMenuSectionForEdit(sectionData = { title: '', items: [] }) {
            menuSectionCounterEdit++;
            const sectionIdSuffix = `s${menuSectionCounterEdit}Edit`;
            const sectionDiv = document.createElement('div');
            sectionDiv.className = 'menu-section';
            sectionDiv.id = `menuSection_${sectionIdSuffix}`;
            sectionDiv.innerHTML = `
                <h4>
                    <label for="menuSectionTitle_${sectionIdSuffix}" data-fr="Titre Section" data-en="Section Title">Titre Section :</label>
                    <button type="button" class="btn btn-danger btn-sm btn-remove-section" aria-label="Remove this menu section"><i class="fas fa-trash"></i></button>
                </h4>
                <input type="text" id="menuSectionTitle_${sectionIdSuffix}" name="menuSectionTitle_${sectionIdSuffix}" class="menu-section-title" required maxlength="100" value="${sectionData.title || ''}" data-fr-placeholder="Ex: Entrées" data-en-placeholder="Ex: Starters">
                <small class="form-error-text" id="menuSectionTitle_${sectionIdSuffix}Error"></small>
                <div class="menu-items-container" id="menuItemsContainer_${sectionIdSuffix}"></div>
                <button type="button" class="btn btn-secondary btn-sm btn-add-item" data-section-id-suffix="${sectionIdSuffix}"><i class="fas fa-plus"></i> <span data-fr="Ajouter Élément" data-en="Add Item">Ajouter Élément</span></button>
            `;
            uiEdit.menuBuilderContainerEdit.appendChild(sectionDiv);
            const itemsContainer = sectionDiv.querySelector(`#menuItemsContainer_${sectionIdSuffix}`);
            (sectionData.items || []).forEach(itemData => addMenuItemForEdit(itemsContainer, sectionIdSuffix, itemData));
            queryTranslatableItemsEdit(); updateUIForLanguageEdit(currentLangEdit);
        }

        function addMenuItemForEdit(itemsContainer, sectionIdSuffix, itemData = { name: '', price: null }) {
            const itemCount = itemsContainer.querySelectorAll('.menu-item-group').length;
            if (itemCount < 5) {
                const itemGroupIdSuffix = `${sectionIdSuffix}i${itemCount}`;
                const itemGroup = document.createElement('div');
                itemGroup.className = 'menu-item-group';
                itemGroup.innerHTML = `
                    <input type="text" name="menuItemName_${itemGroupIdSuffix}" id="menuItemName_${itemGroupIdSuffix}" class="menu-item-name" required maxlength="150" value="${itemData.name || ''}" data-fr-placeholder="Nom de l'élément" data-en-placeholder="Item name" aria-label="Menu item name">
                    <input type="number" name="menuItemPrice_${itemGroupIdSuffix}" id="menuItemPrice_${itemGroupIdSuffix}" class="menu-item-price" min="0" step="0.01" value="${itemData.price !== null && itemData.price !== undefined ? itemData.price : ''}" data-fr-placeholder="Prix (€, opt.)" data-en-placeholder="Price (€, opt.)" aria-label="Menu item price" style="width:120px;">
                    <button type="button" class="btn btn-danger btn-sm btn-remove-item" aria-label="Remove this item"><i class="fas fa-minus"></i></button>
                `;
                itemsContainer.appendChild(itemGroup);
            }
        }
        
        if (uiEdit.addMenuSectionBtnEdit) {
            uiEdit.addMenuSectionBtnEdit.addEventListener('click', () => addMenuSectionForEdit());
        }
        uiEdit.menuBuilderContainerEdit.addEventListener('click', function(e) {
            const addBtn = e.target.closest('.btn-add-item');
            const removeItemBtn = e.target.closest('.btn-remove-item');
            const removeSectionBtn = e.target.closest('.btn-remove-section');
            if (addBtn) {
                const sectionIdSuffix = addBtn.dataset.sectionIdSuffix;
                const itemsContainer = document.getElementById(`menuItemsContainer_${sectionIdSuffix}`);
                addMenuItemForEdit(itemsContainer, sectionIdSuffix);
                queryTranslatableItemsEdit(); updateUIForLanguageEdit(currentLangEdit);
            } else if (removeItemBtn) {
                removeItemBtn.closest('.menu-item-group').remove();
            } else if (removeSectionBtn) {
                removeSectionBtn.closest('.menu-section').remove();
            }
        });

        function renderMenuBuilderForEdit(menuStructure = []) {
            uiEdit.menuBuilderContainerEdit.innerHTML = ''; 
            menuSectionCounterEdit = 0; 
            if (Array.isArray(menuStructure)) {
                menuStructure.forEach(sectionData => addMenuSectionForEdit(sectionData));
            }
        }

        if (uiEdit.isPaidEventCheckboxEdit) {
            uiEdit.isPaidEventCheckboxEdit.addEventListener('change', function() {
                uiEdit.eventPriceGroupEdit.style.display = this.checked ? 'block' : 'none';
                uiEdit.eventPriceInputEdit.required = this.checked;
                if (!this.checked) {uiEdit.eventPriceInputEdit.value = ''; displayFieldErrorEdit('eventPriceEdit','');}
            });
        }

        function populateEditForm(eventDetails) {
            uiEdit.editingEventIdInput.value = eventDetails.id;
            uiEdit.loadedEventNameDisplay.textContent = eventDetails.eventName;
            uiEdit.eventNameEdit.value = eventDetails.eventName || '';
            uiEdit.organizerNameEdit.value = eventDetails.organizerName || '';
            uiEdit.eventDescriptionTextareaEdit.value = eventDetails.eventDescription || '';
            uiEdit.eventDescriptionTextareaEdit.dispatchEvent(new Event('input'));

            uiEdit.eventStartDateEdit.value = eventDetails.eventStartDate || '';
            uiEdit.eventStartTimeEdit.value = eventDetails.eventStartTime || '';
            uiEdit.eventEndDateEdit.value = eventDetails.eventEndDate || '';
            uiEdit.eventEndTimeEdit.value = eventDetails.eventEndTime || '';
            uiEdit.registrationDeadlineDateEdit.value = eventDetails.registrationDeadlineDate || '';
            uiEdit.registrationDeadlineTimeEdit.value = eventDetails.registrationDeadlineTime || '';

            uiEdit.isRecurringEventCheckboxEdit.checked = !!eventDetails.recurringRule;
            uiEdit.recurringRuleGroupEdit.style.display = uiEdit.isRecurringEventCheckboxEdit.checked ? 'block' : 'none';
            uiEdit.recurringRuleInputEdit.value = eventDetails.recurringRule || '';
            uiEdit.recurringRuleInputEdit.required = uiEdit.isRecurringEventCheckboxEdit.checked;

            if (eventDetails.locationType === 'online') {
                uiEdit.locationTypeOnlineRadioEdit.checked = true;
                uiEdit.onlineMeetingLinkInputEdit.value = eventDetails.onlineMeetingLink || '';
            } else {
                uiEdit.locationTypeOfflineRadioEdit.checked = true;
                uiEdit.venueNameEdit.value = eventDetails.venueName || '';
                uiEdit.eventLocationAddressTextareaEdit.value = eventDetails.eventLocationAddress || '';
                uiEdit.eventLocationGMapLinkInputEdit.value = eventDetails.eventLocationGMapLink || '';
            }
            handleLocationTypeChangeEdit();

            uiEdit.numTablesEdit.value = eventDetails.numTables !== null ? eventDetails.numTables : '0';
            uiEdit.chairsPerTableEdit.value = eventDetails.chairsPerTable !== null ? eventDetails.chairsPerTable : '0';
            uiEdit.allowSeatSelectionCheckboxEdit.checked = !!eventDetails.allowSeatSelection;
            uiEdit.maxRegistrationsPerUserEdit.value = eventDetails.maxRegistrationsPerUser !== null ? eventDetails.maxRegistrationsPerUser : '0';
            uiEdit.enableWaitlistCheckboxEdit.checked = !!eventDetails.enableWaitlist;

            renderMenuBuilderForEdit(eventDetails.menuStructure || []);

            uiEdit.isPaidEventCheckboxEdit.checked = !!eventDetails.isPaidEvent;
            uiEdit.isPaidEventCheckboxEdit.dispatchEvent(new Event('change'));
            if (uiEdit.isPaidEventCheckboxEdit.checked) {
                uiEdit.eventPriceInputEdit.value = eventDetails.eventPrice !== null ? eventDetails.eventPrice : '';
            }
            uiEdit.eventBadgeSelectEdit.value = eventDetails.eventBadge || 'none';
        }

        function validateEditForm(showGeneralMsg = true) {
            let isValid = true;
            clearFieldErrorsEdit();
            if (!uiEdit.eventNameEdit.value.trim()) { displayFieldErrorEdit('eventName', 'required'); isValid = false; }
            if (!uiEdit.eventDescriptionTextareaEdit.value.trim()) { displayFieldErrorEdit('eventDescriptionEdit', 'required'); isValid = false; }
            
            [uiEdit.eventStartDateEdit, uiEdit.eventEndDateEdit, uiEdit.registrationDeadlineDateEdit].forEach(input => {
                if (!input.value) { displayFieldErrorEdit(input.id.replace('Edit',''), 'required'); isValid = false; }
            });
            if (uiEdit.eventStartDateEdit.value && uiEdit.eventEndDateEdit.value) {
                const startDT = new Date(uiEdit.eventStartDateEdit.value + "T" + (uiEdit.eventStartTimeEdit.value || "00:00:00"));
                const endDT = new Date(uiEdit.eventEndDateEdit.value + "T" + (uiEdit.eventEndTimeEdit.value || "23:59:59"));
                if (endDT <= startDT) { displayFieldErrorEdit('eventEndDate', 'endDateBeforeStart'); isValid = false; }
                if (uiEdit.registrationDeadlineDateEdit.value) {
                    const deadlineDT = new Date(uiEdit.registrationDeadlineDateEdit.value + "T" + (uiEdit.registrationDeadlineTimeEdit.value || "23:59:59"));
                    if (deadlineDT >= startDT) { displayFieldErrorEdit('registrationDeadlineDate', 'deadlineAfterStart'); isValid = false; }
                    if (deadlineDT >= endDT) { displayFieldErrorEdit('registrationDeadlineDate', 'deadlineTooCloseToEnd'); isValid = false; }
                }
            }
            if (uiEdit.isRecurringEventCheckboxEdit.checked && !uiEdit.recurringRuleInputEdit.value.trim()){ displayFieldErrorEdit('recurringRule', 'required'); isValid = false; }

            if (uiEdit.locationTypeOfflineRadioEdit.checked) {
                if (!uiEdit.venueNameEdit.value.trim()) { displayFieldErrorEdit('venueName', 'venueNameRequired'); isValid = false; }
                if (!uiEdit.eventLocationAddressTextareaEdit.value.trim() && !uiEdit.eventLocationGMapLinkInputEdit.value.trim()) { displayFieldErrorEdit('eventLocationAddress', 'addressOrGMapRequired'); isValid = false; }
                if (uiEdit.eventLocationGMapLinkInputEdit.value.trim() && !/^https?:\/\/.+/.test(uiEdit.eventLocationGMapLinkInputEdit.value.trim())) { displayFieldErrorEdit('eventLocationGMapLink', 'invalidUrl'); isValid = false; }
            } else if (uiEdit.locationTypeOnlineRadioEdit.checked) {
                if (!uiEdit.onlineMeetingLinkInputEdit.value.trim()) { displayFieldErrorEdit('onlineMeetingLink', 'onlineLinkRequired'); isValid = false; }
                 if (uiEdit.onlineMeetingLinkInputEdit.value.trim() && !/^https?:\/\/.+/.test(uiEdit.onlineMeetingLinkInputEdit.value.trim())) { displayFieldErrorEdit('onlineMeetingLink', 'invalidUrl'); isValid = false; }
            }

            document.querySelectorAll('#menuBuilderContainerEdit .menu-section').forEach((sectionDiv) => {
                const titleInput = sectionDiv.querySelector('.menu-section-title');
                if (!titleInput.value.trim()) { titleInput.classList.add('form-error'); isValid = false; } else { titleInput.classList.remove('form-error');}
                sectionDiv.querySelectorAll('.menu-item-name').forEach((itemInput) => {
                    if (!itemInput.value.trim()) { itemInput.classList.add('form-error'); isValid = false; } else { itemInput.classList.remove('form-error');}
                });
            });
            if (uiEdit.isPaidEventCheckboxEdit.checked && !uiEdit.eventPriceInputEdit.value) { displayFieldErrorEdit('eventPrice', 'required'); isValid = false; }

            if (!isValid && showGeneralMsg) {
                displayMessageInline(getMessageEdit('formErrors'), 'error');
                const firstInvalidField = uiEdit.editEventForm.querySelector('.form-error, :invalid:not(fieldset)');
                if (firstInvalidField) { firstInvalidField.focus({preventScroll:true}); firstInvalidField.scrollIntoView({ behavior: 'smooth', block: 'center' });}
            }
            return isValid;
        }

        // --- Authentication Form ---
        uiEdit.authEventForm.addEventListener('submit', async function(event) {
            event.preventDefault(); clearMessageInline();
            const eventId = this.elements.authEventId.value.trim();
            const password = this.elements.authAdminPassword.value;
            const submitButton = this.querySelector('button[type="submit"]');
            const originalButtonHTML = submitButton.innerHTML;

            if (!eventId) { displayFieldErrorEdit('authEventId', 'required'); return; }
            if (!password) { displayFieldErrorEdit('authAdminPassword', 'required'); return; }

            submitButton.disabled = true; submitButton.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${getMessageEdit('loadingEvent')}`;
            
            try {
                const response = await fetch(`${WORKER_BASE_URL}/${eventId}/admin`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ adminPassword: password })
                });
                const result = await response.json();
                if (response.ok && result.success && result.eventDetails) {
                    currentAuthenticatedPassword = password;
                    currentlyEditingEventId = eventId;
                    currentLoadedEventFullData = result;

                    populateEditForm(result.eventDetails);
                    renderDashboard(result.eventDetails, result.registrations || []);
                    renderAttendeeList(result.registrations || []);
                    if(result.eventDetails.enableWaitlist){ renderWaitlist(result.waitlist || []); }
                    else { uiEdit.waitlistManagementSectionEl.style.display = 'none'; }

                    uiEdit.authSection.style.display = 'none';
                    uiEdit.eventDashboardAndEditSection.style.display = 'block';
                    displayMessageInline(getMessageEdit('eventLoaded'), 'success');
                    this.reset();
                } else {
                    displayMessageInline(result.error || getMessageEdit('authError'), 'error');
                }
            } catch (e) {
                console.error("Auth fetch error:", e); displayMessageInline(getMessageEdit('apiError') + `: ${e.message}`, 'error');
            } finally {
                submitButton.disabled = false; submitButton.innerHTML = originalButtonHTML;
            }
        });

        // --- Edit Event Form Submission ---
        uiEdit.editEventForm.addEventListener('submit', async function(event) {
            event.preventDefault(); clearMessageInline();
            if (!validateEditForm()) return;

            const eventId = uiEdit.editingEventIdInput.value;
            if (!eventId || !currentAuthenticatedPassword) { displayMessageInline("Erreur: Session invalide ou ID manquant.", 'error'); return; }

            const formData = new FormData(this);
            const eventDataToUpdate = {};
            eventDataToUpdate.eventName = formData.get('eventName');
            eventDataToUpdate.organizerName = formData.get('organizerName') || null;
            eventDataToUpdate.eventDescription = formData.get('eventDescription');
            eventDataToUpdate.eventStartDate = formData.get('eventStartDate');
            eventDataToUpdate.eventStartTime = formData.get('eventStartTime') || null;
            eventDataToUpdate.eventEndDate = formData.get('eventEndDate');
            eventDataToUpdate.eventEndTime = formData.get('eventEndTime') || null;
            eventDataToUpdate.registrationDeadlineDate = formData.get('registrationDeadlineDate');
            eventDataToUpdate.registrationDeadlineTime = formData.get('registrationDeadlineTime') || null;
            eventDataToUpdate.isRecurringEvent = formData.has('isRecurringEventEdit'); // Not a direct DB field
            eventDataToUpdate.recurringRule = eventDataToUpdate.isRecurringEvent ? (formData.get('recurringRule') || null) : null;
            eventDataToUpdate.locationType = formData.get('locationType');
            if (eventDataToUpdate.locationType === 'offline') {
                eventDataToUpdate.venueName = formData.get('venueName') || null;
                eventDataToUpdate.eventLocationAddress = formData.get('eventLocationAddress') || null;
                eventDataToUpdate.eventLocationGMapLink = formData.get('eventLocationGMapLink') || null;
            } else {
                eventDataToUpdate.onlineMeetingLink = formData.get('onlineMeetingLink') || null;
            }
            eventDataToUpdate.numTables = parseInt(formData.get('numTables') || 0);
            eventDataToUpdate.chairsPerTable = parseInt(formData.get('chairsPerTable') || 0);
            eventDataToUpdate.allowSeatSelection = formData.has('allowSeatSelectionEdit');
            eventDataToUpdate.maxRegistrationsPerUser = parseInt(formData.get('maxRegistrationsPerUser') || 0);
            eventDataToUpdate.enableWaitlist = formData.has('enableWaitlistEdit');
            eventDataToUpdate.menuStructure = [];
            document.querySelectorAll('#menuBuilderContainerEdit .menu-section').forEach((sectionDiv) => {
                const titleInput = sectionDiv.querySelector('.menu-section-title');
                const sectionTitle = titleInput ? titleInput.value.trim() : '';
                const items = [];
                sectionDiv.querySelectorAll('.menu-item-group').forEach(itemGroup => {
                    const nameInput = itemGroup.querySelector('.menu-item-name');
                    const priceInput = itemGroup.querySelector('.menu-item-price');
                    if (nameInput && nameInput.value.trim()) {
                        items.push({ name: nameInput.value.trim(), price: priceInput && priceInput.value.trim() ? parseFloat(priceInput.value) : null });
                    }
                });
                if (sectionTitle) { eventDataToUpdate.menuStructure.push({ title: sectionTitle, items: items }); }
            });
            eventDataToUpdate.isPaidEvent = formData.has('isPaidEventEdit');
            eventDataToUpdate.eventPrice = eventDataToUpdate.isPaidEvent ? parseFloat(formData.get('eventPrice') || 0) : null;
            eventDataToUpdate.eventBadge = formData.get('eventBadge');

            const submitButton = this.querySelector('button[type="submit"]');
            const originalButtonHTML = submitButton.innerHTML;
            submitButton.disabled = true; submitButton.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${getMessageEdit('savingChanges')}`;

            try {
                const response = await fetch(`${WORKER_BASE_URL}/${eventId}`, {
                    method: 'PUT', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ eventData: eventDataToUpdate, adminPassword: currentAuthenticatedPassword })
                });
                const result = await response.json();
                if (response.ok && result.success) {
                    displayMessageInline(getMessageEdit('changesSaved'), 'success');
                    currentLoadedEventFullData.eventDetails = {...currentLoadedEventFullData.eventDetails, ...eventDataToUpdate};
                    uiEdit.loadedEventNameDisplay.textContent = eventDataToUpdate.eventName;
                    renderDashboard(currentLoadedEventFullData.eventDetails, currentLoadedEventFullData.registrations);
                } else {
                    displayMessageInline(result.error || getMessageEdit('apiError'), 'error');
                }
            } catch (e) {
                console.error("Update error:", e); displayMessageInline(getMessageEdit('apiError') + `: ${e.message}`, 'error');
            } finally {
                submitButton.disabled = false; submitButton.innerHTML = originalButtonHTML;
            }
        });

        uiEdit.deleteEventButton.addEventListener('click', async function() {
            clearMessageInline(); const eventId = uiEdit.editingEventIdInput.value;
            if (!eventId || !currentAuthenticatedPassword) { displayMessageInline("Session invalide.", 'error'); return; }
            if (confirm(getMessageEdit('confirmDelete'))) {
                const originalButtonHTML = this.innerHTML; this.disabled = true; this.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${getMessageEdit('deletingEvent')}`;
                try {
                    const response = await fetch(`${WORKER_BASE_URL}/${eventId}`, {
                        method: 'DELETE', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ adminPassword: currentAuthenticatedPassword })
                    });
                    const result = await response.json();
                    if (response.ok && result.success) {
                        displayMessageInline(getMessageEdit('eventDeleted'), 'success');
                        uiEdit.eventDashboardAndEditSection.style.display = 'none'; uiEdit.authSection.style.display = 'block'; uiEdit.authEventForm.reset();
                        currentAuthenticatedPassword = null; currentlyEditingEventId = null; currentLoadedEventFullData = null; uiEdit.loadedEventNameDisplay.textContent = "";
                    } else { displayMessageInline(result.error || getMessageEdit('apiError'), 'error'); }
                } catch (e) { console.error("Delete error:", e); displayMessageInline(getMessageEdit('apiError') + `: ${e.message}`, 'error');
                } finally { this.disabled = false; this.innerHTML = originalButtonHTML; }
            }
        });
        uiEdit.cancelEditButton.addEventListener('click', function() {
            clearMessageInline(); uiEdit.eventDashboardAndEditSection.style.display = 'none'; uiEdit.authSection.style.display = 'block';
            uiEdit.authEventForm.reset(); currentAuthenticatedPassword = null; currentlyEditingEventId = null; currentLoadedEventFullData = null; uiEdit.loadedEventNameDisplay.textContent = "";
        });

        function renderDashboard(eventDetails, registrations = []) {
            const numTables = parseInt(eventDetails.numTables, 10) || 0; const chairsPerTable = parseInt(eventDetails.chairsPerTable, 10) || 0;
            const totalCapacity = numTables * chairsPerTable; const totalRegistered = registrations ? registrations.length : 0;
            const seatsRemaining = totalCapacity - totalRegistered; const capacityPercent = totalCapacity > 0 ? Math.min(100, Math.round((totalRegistered / totalCapacity) * 100)) : 0;
            uiEdit.totalCapacityEl.textContent = totalCapacity; uiEdit.totalRegisteredEl.textContent = totalRegistered;
            uiEdit.seatsRemainingEl.textContent = seatsRemaining < 0 ? 0 : seatsRemaining;
            uiEdit.capacityProgressBarEl.style.width = `${capacityPercent}%`; uiEdit.capacityPercentageEl.textContent = `${capacityPercent}%`;
            if(capacityPercent >= 90) uiEdit.capacityProgressBarEl.style.backgroundColor = 'var(--danger-color-form)'; else if (capacityPercent >=70) uiEdit.capacityProgressBarEl.style.backgroundColor = '#ffc107'; else uiEdit.capacityProgressBarEl.style.backgroundColor = 'var(--primary-color-form)';
            uiEdit.menuStatsContainerEl.innerHTML = '';
            if (eventDetails.menuStructure && Array.isArray(eventDetails.menuStructure) && eventDetails.menuStructure.length > 0 && registrations && registrations.length > 0) {
                let totalMenuChoicesMade = 0; const menuChoiceCounts = {};
                eventDetails.menuStructure.forEach(section => { section.items.forEach(item => menuChoiceCounts[item.name] = 0);}); // Initialize all possible menu items
                registrations.forEach(reg => { if (reg.menuChoice && menuChoiceCounts.hasOwnProperty(reg.menuChoice)) { menuChoiceCounts[reg.menuChoice]++; totalMenuChoicesMade++; }});
                
                let menuStatsHTML = '';
                for (const menuName in menuChoiceCounts) {
                    if (menuChoiceCounts.hasOwnProperty(menuName)) { // Check if it's an actual menu item from the structure
                        const count = menuChoiceCounts[menuName];
                        if (count > 0) { // Only display if chosen at least once
                            const percentage = totalMenuChoicesMade > 0 ? Math.round((count / totalMenuChoicesMade) * 100) : 0;
                            menuStatsHTML += `<p>${menuName}: <strong class="stat-value" style="font-size:1.2rem;">${count}</strong> (${percentage}%)</p>`;
                        }
                    }
                }
                uiEdit.menuStatsContainerEl.innerHTML = menuStatsHTML || `<p>${getMessageEdit('noMenuData')}</p>`;

            } else { uiEdit.menuStatsContainerEl.innerHTML = `<p>${getMessageEdit('noMenuData')}</p>`;}
            if (eventDetails.isPaidEvent) {
                uiEdit.paymentStatsCardEl.style.display = 'block'; let paidYes = 0; let paidNo = 0;
                (registrations || []).forEach(reg => { if (reg.paidStatus === 'yes' || reg.paidStatus === 1) paidYes++; else if (reg.paidStatus === 'no' || reg.paidStatus === 0) paidNo++; });
                uiEdit.countPaidYesEl.textContent = paidYes; uiEdit.countPaidNoEl.textContent = paidNo;
            } else { uiEdit.paymentStatsCardEl.style.display = 'none'; }
            renderTableVisualization(numTables, chairsPerTable, registrations, eventDetails.allowSeatSelection);
        }
        function renderTableVisualization(numTables, chairsPerTable, registrations = [], allowSeatSelection = false) {
            uiEdit.tableVisualizationEl.innerHTML = ''; if (numTables === 0 || chairsPerTable === 0) { uiEdit.tableVisualizationEl.innerHTML = `<p>${getMessageEdit('configureTables')}</p>`; return; }
            const bookedSeatsMap = new Map();
            (registrations || []).forEach(reg => { if (reg.tableNumber !== undefined && reg.seatNumber !== undefined) { bookedSeatsMap.set(`T${reg.tableNumber -1}-S${reg.seatNumber -1}`, reg); }});
            for (let t = 0; t < numTables; t++) {
                const tableDiv = document.createElement('div'); tableDiv.className = 'event-table';
                const tableTitle = document.createElement('div'); tableTitle.className = 'event-table-title'; tableTitle.textContent = `${getMessageEdit('tableLabel')} ${t + 1}`; tableDiv.appendChild(tableTitle);
                const seatsGrid = document.createElement('div'); seatsGrid.className = 'seats-grid'; const maxCols = Math.min(chairsPerTable, 10); seatsGrid.style.gridTemplateColumns = `repeat(${maxCols}, 1fr)`;
                for (let s = 0; s < chairsPerTable; s++) {
                    const seatDiv = document.createElement('div'); seatDiv.className = 'seat'; seatDiv.textContent = s + 1;
                    const seatKey = `T${t}-S${s}`; const registration = bookedSeatsMap.get(seatKey);
                    if (registration) {
                        seatDiv.classList.add('booked'); seatDiv.title = `${getMessageEdit('attendeeName')}: ${registration.userName}`;
                        const tooltip = document.createElement('span'); tooltip.className = 'seat-tooltip';
                        tooltip.innerHTML = `<strong>${registration.userName}</strong><br>${getMessageEdit('attendeeMenu')}: ${registration.menuChoice || 'N/A'}`;
                        if(currentLoadedEventFullData.eventDetails.isPaidEvent){ tooltip.innerHTML += `<br>${getMessageEdit('attendeePaid')}: ${registration.paidStatus === 'yes' || registration.paidStatus === 1 ? getMessageEdit('statusYes') : getMessageEdit('statusNo')}`; }
                        seatDiv.appendChild(tooltip);
                    } else { seatDiv.classList.add('available'); }
                    seatsGrid.appendChild(seatDiv);
                }
                tableDiv.appendChild(seatsGrid); uiEdit.tableVisualizationEl.appendChild(tableDiv);
            }
        }
        function renderAttendeeList(registrations = []) {
            uiEdit.attendeeListBodyEl.innerHTML = ''; if (!registrations || registrations.length === 0) { const tr = uiEdit.attendeeListBodyEl.insertRow(); const td = tr.insertCell(); td.colSpan = 6; td.textContent = getMessageEdit('noAttendees'); return; }
            registrations.forEach(reg => { const row = uiEdit.attendeeListBodyEl.insertRow();
                row.insertCell().textContent = reg.userName || ''; row.insertCell().textContent = reg.userEmail || ''; row.insertCell().textContent = reg.userPhone || '';
                row.insertCell().textContent = reg.menuChoice || 'N/A';
                row.insertCell().textContent = reg.registrationDate ? new Date(reg.registrationDate).toLocaleDateString(currentLangEdit === 'fr' ? 'fr-FR' : 'en-US', {day:'2-digit', month:'short', year:'numeric', hour:'2-digit', minute:'2-digit'}) : 'N/A';
                row.insertCell().textContent = (currentLoadedEventFullData.eventDetails.isPaidEvent && reg.paidStatus) ? (reg.paidStatus === 'yes' || reg.paidStatus === 1 ? getMessageEdit('statusYes') : getMessageEdit('statusNo')) : 'N/A';
            });
        }
        function renderWaitlist(waitlist = []) {
            uiEdit.waitlistManagementSectionEl.style.display = 'block'; uiEdit.waitlistCountEl.textContent = waitlist.length; uiEdit.waitlistBodyEl.innerHTML = '';
            if (!waitlist || waitlist.length === 0) { const tr = uiEdit.waitlistBodyEl.insertRow(); const td = tr.insertCell(); td.colSpan = 4; td.textContent = getMessageEdit('waitlistEmpty'); return; }
            waitlist.forEach(item => { const row = uiEdit.waitlistBodyEl.insertRow();
                row.insertCell().textContent = item.userName || ''; row.insertCell().textContent = item.userEmail || ''; row.insertCell().textContent = item.userPhone || '';
                row.insertCell().textContent = item.waitlistDate ? new Date(item.waitlistDate).toLocaleDateString(currentLangEdit === 'fr' ? 'fr-FR' : 'en-US', {day:'2-digit', month:'short', year:'numeric'}) : 'N/A';
            });
        }
        function exportAttendeesToCSV(registrations, eventName) { /* ... (Keep existing) ... */
            if (!registrations || registrations.length === 0) { alert(getMessageEdit('noDataToExport')); return; }
            const headers = [getMessageEdit('attendeeName'), getMessageEdit('attendeeEmail'), "Phone", getMessageEdit('attendeeMenu'), "Registration Date", getMessageEdit('attendeePaid')];
            let csvContent = "data:text/csv;charset=utf-8," + headers.join(",") + "\n";
            registrations.forEach(reg => {
                const paidText = (currentLoadedEventFullData.eventDetails.isPaidEvent && reg.paidStatus) ? (reg.paidStatus === 'yes' || reg.paidStatus === 1 ? getMessageEdit('statusYes') : getMessageEdit('statusNo')) : 'N/A';
                const regDate = reg.registrationDate ? new Date(reg.registrationDate).toISOString() : 'N/A';
                const row = [reg.userName, reg.userEmail, reg.userPhone, reg.menuChoice, regDate, paidText];
                const escapedRow = row.map(field => `"${String(field || '').replace(/"/g, '""')}"`); csvContent += escapedRow.join(",") + "\n";
            });
            const encodedUri = encodeURI(csvContent); const link = document.createElement("a"); link.setAttribute("href", encodedUri);
            const safeEventName = eventName.replace(/[^a-z0-9]/gi, '_').toLowerCase(); link.setAttribute("download", `inscriptions_${safeEventName}.csv`);
            document.body.appendChild(link); link.click(); document.body.removeChild(link);
        }
        uiEdit.exportCsvButton.addEventListener('click', function() {
            if (currentLoadedEventFullData && currentLoadedEventFullData.registrations) { exportAttendeesToCSV(currentLoadedEventFullData.registrations, currentLoadedEventFullData.eventDetails.eventName); }
            else { alert(getMessageEdit('noDataToExport')); }
        });

        // --- Initial Page Setup ---
        queryTranslatableItemsEdit();
        const preferredLangEdit = detectLanguagePreferenceEdit();
        updateUIForLanguageEdit(preferredLangEdit);
        
        const urlParams = new URLSearchParams(window.location.search);
        const eventIdFromUrl = urlParams.get('id');
        if (eventIdFromUrl) {
            document.getElementById('authEventId').value = eventIdFromUrl;
        }
        
        window.triggerPageLanguageUpdate = function(langFromHf) { // For hf.js
            if (langFromHf !== currentLangEdit) { queryTranslatableItemsEdit(); updateUIForLanguageEdit(langFromHf); }
            else { queryTranslatableItemsEdit(); updateUIForLanguageEdit(currentLangEdit); }
        };
        if (window.hfHasLoaded && window.hfInitialLang) { // If hf.js loaded first
            triggerPageLanguageUpdate(window.hfInitialLang);
        }

        console.log("edit-event.html JS (Enhanced Features & Optional Time) loaded.");
    });
    </script>
</body>
</html>
