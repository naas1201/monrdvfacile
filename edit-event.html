<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title data-fr="Modifier un Événement - MonRdvFacile" data-en="Edit Event - MyEasyMeeting">Modifier un Événement - MonRdvFacile</title>
    <meta name="description" content="Page de modification d'événements pour MonRdvFacile. Mettez à jour les détails de votre événement et gérez les inscriptions.">
    <meta name="robots" content="noindex, nofollow">
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-K2JVSXZXNN"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-K2JVSXZXNN');
    </script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <style>
        /* --- Inline CSS for edit-event.html (Combined & Extended) --- */
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html { font-size: 16px; scroll-behavior: smooth; -webkit-text-size-adjust: 100%; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            line-height: 1.6; background-color: #F8F9FA; color: #333333;
            display: flex; flex-direction: column; min-height: 100vh;
            -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
        }
        h1, h2, h3, h4, h5, h6 { font-weight: 600; color: #003366; margin-bottom: 0.75rem; line-height: 1.3; }
        h1 { font-size: 2.25rem; margin-top: 1rem; }
        h2 { font-size: 1.75rem; }
        h3 { font-size: 1.5rem; margin-top: 1.5rem; border-bottom: 1px solid #DEE2E6; padding-bottom: 0.5rem;}
        p { margin-bottom: 1rem; }
        a { color: #005A9C; text-decoration: none; transition: color 0.2s ease-in-out; }
        a:hover, a:focus { color: #003366; text-decoration: underline; }
        .container { width: 90%; max-width: 1200px; margin-left: auto; margin-right: auto; padding: 20px 15px; }
        main.container { flex-grow: 1; }
        .main-title { text-align: center; margin-bottom: 1.5rem; color: #004170; }

        .lang-toggle { text-align: right; margin-bottom: 1rem; font-size: 0.9rem; }
        .lang-link { color: #555555; text-decoration: none; padding: 0.2rem 0.4rem; border-radius: 3px; cursor:pointer; }
        .lang-link.active { font-weight: bold; color: #005A9C; background-color: #e9ecef; }
        .lang-link:hover { background-color: #dee2e6; text-decoration: none; }

        #app-header { background-color: #005A9C; color: #FFFFFF; padding: 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 1000; }
        .header-container { display: flex; justify-content: space-between; align-items: center; padding-top: 1rem; padding-bottom: 1rem; max-width: 1200px; margin: 0 auto; width: 90%;}
        .logo a { font-size: 1.5rem; font-weight: bold; color: #FFFFFF; text-decoration: none; }
        .main-nav ul { list-style: none; margin: 0; padding: 0; display: flex; }
        .main-nav li { margin-left: 20px; }
        .main-nav a { color: #FFFFFF; text-decoration: none; font-size: 1rem; padding: 5px 10px; border-radius: 4px; transition: background-color 0.2s ease; }
        .main-nav a:hover, .main-nav a.active { background-color: #004170; }
        .main-nav .nav-text { margin-left: 5px; } /* If icons are used in nav */
        .mobile-nav-toggle { display: none; border: none; background: none; color: #FFFFFF; font-size: 1.5rem; cursor: pointer; }


        #app-footer { background-color: #333333; color: #E0E0E0; padding: 2rem 0; text-align: center; font-size: 0.9rem; margin-top: auto; }
        #app-footer a { color: #B0C4DE; }
        #app-footer a:hover { color: #FFFFFF; text-decoration: underline; }
        .footer-container { max-width: 1200px; margin: 0 auto; width: 90%; }

        .section-container { background-color: #FFFFFF; padding: 25px 30px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08); margin-top: 20px; margin-bottom: 30px; }
        fieldset { border: 1px solid #CED4DA; padding: 20px; margin-bottom: 25px; border-radius: 6px; }
        legend { font-size: 1.25rem; font-weight: 600; color: #004170; padding: 0 10px; margin-left: 5px; }
        .form-group { margin-bottom: 1.25rem; }
        .form-group-inline { display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 1.25rem; }
        .form-group-inline .form-group { flex: 1; min-width: 200px; margin-bottom: 0; }
        label { display: block; font-weight: 500; color: #343A40; margin-bottom: 0.5rem; font-size: 1rem; }
        input[type="text"], input[type="password"], input[type="date"], input[type="time"], input[type="number"], textarea, select {
            width: 100%; padding: 0.75rem 1rem; font-size: 1rem; line-height: 1.5; color: #495057;
            background-color: #FFFFFF; border: 1px solid #CED4DA; border-radius: 5px;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.075);
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }
        input[type="date"], input[type="time"] { min-height: calc(1.5em + 1.5rem + 2px); }
        textarea { resize: vertical; min-height: 80px; }
        select {
            appearance: none; -webkit-appearance: none; -moz-appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23005A9C%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat; background-position: right 1rem center; background-size: 0.8em; padding-right: 2.5rem;
        }
        select::-ms-expand { display: none; }
        input[type="text"]:focus, input[type="password"]:focus, input[type="date"]:focus,
        input[type="time"]:focus, input[type="number"]:focus, textarea:focus, select:focus {
            border-color: #005A9C; outline: 0; box-shadow: 0 0 0 0.2rem rgba(0, 90, 156, 0.25);
        }
        ::placeholder { color: #6C757D; opacity: 1; }
        .form-group-checkbox { display: flex; align-items: center; gap: 0.5rem; }
        .form-group-checkbox input[type="checkbox"] { width: auto; margin-right: 8px; transform: scale(1.3); accent-color: #005A9C; }
        .form-group-checkbox label { margin-bottom: 0; font-weight: normal; }
        small, .form-text { display: block; margin-top: 0.35rem; font-size: 0.875rem; color: #6C757D; }
        .form-actions { margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid #E9ECEF; display: flex; flex-wrap: wrap; gap: 1rem; justify-content: flex-end; }
        .btn {
            display: inline-block; font-weight: 500; color: #FFFFFF; text-align: center; vertical-align: middle;
            cursor: pointer; user-select: none; background-color: #007BFF; border: 1px solid transparent;
            padding: 0.75rem 1.25rem; font-size: 1rem; line-height: 1.5; border-radius: 0.3rem;
            transition: all 0.15s ease-in-out;
        }
        .btn:hover { background-color: #0056b3; text-decoration: none; color: #FFFFFF; }
        .btn-primary { background-color: #005A9C; border-color: #005A9C; }
        .btn-primary:hover { background-color: #004170; border-color: #003355; }
        .btn-secondary { background-color: #6C757D; border-color: #6C757D; }
        .btn-secondary:hover { background-color: #5A6268; border-color: #545B62; }
        .btn-danger { background-color: #DC3545; border-color: #DC3545; }
        .btn-danger:hover { background-color: #C82333; border-color: #BD2130; }
        .btn-info { background-color: #17A2B8; border-color: #17A2B8; color: white; }
        .btn-info:hover { background-color: #117A8B; border-color: #10707F;}
        .form-actions .btn i { margin-right: 0.5rem; }
        #menuNameInputsContainerEdit .form-group { padding-left: 15px; border-left: 3px solid #E9ECEF; }
        #menuNameInputsContainerEdit .form-group:last-child { margin-bottom: 0; }

        .form-message { padding: 15px 20px; margin-bottom: 20px; border-radius: 5px; border: 1px solid transparent; font-size: 1rem; display: none; line-height:1.5;}
        .form-message-error { color: #721C24; background-color: #F8D7DA; border-color: #F5C6CB; display: block; }
        .form-message-success { color: #155724; background-color: #D4EDDA; border-color: #C3E6CB; display: block; }
        .form-message-info { color: #0C5460; background-color: #D1ECF1; border-color: #BEE5EB; display: block; }

        .fa-spinner { animation: fa-spin 1s infinite linear; }
        @keyframes fa-spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Dashboard Specific Styles */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom:20px; }
        .dashboard-card { background-color: #fff; padding: 20px; border-radius: 6px; box-shadow: 0 2px 8px rgba(0,0,0,0.07); }
        .dashboard-card h4 { font-size: 1.1rem; color: #004170; margin-top:0; margin-bottom:10px; }
        .progress-bar-container { background-color: #e9ecef; border-radius: .25rem; height: 20px; overflow: hidden; margin-bottom: 5px; }
        .progress-bar { background-color: #005A9C; height: 100%; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.8rem; transition: width 0.6s ease; }
        .stat-value { font-size: 1.8rem; font-weight: bold; color: #003366; }
        .stat-label { font-size: 0.9rem; color: #6c757d; }

        /* Table Visualization */
        #tableVisualization { display: flex; flex-wrap: wrap; gap: 20px; padding:10px; border: 1px solid #eee; border-radius:5px; background:#fdfdfd; }
        .event-table { border: 2px solid #005A9C; border-radius: 5px; padding: 10px; background-color: #f0f8ff; }
        .event-table-title { font-weight: bold; margin-bottom: 8px; text-align:center; font-size:0.9rem; color: #004170;}
        .seats-grid { display: grid; gap: 5px; /* grid-template-columns will be set by JS */ }
        .seat {
            width: 30px; height: 30px; border-radius: 3px;
            display: flex; align-items: center; justify-content: center;
            font-size: 0.7rem; color: white; cursor: default;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .seat.available { background-color: #28a745; /* Green */ }
        .seat.booked { background-color: #dc3545; /* Red */ }
        .seat.booked:hover { transform: scale(1.1); box-shadow: 0 0 8px rgba(0,0,0,0.3); z-index:10; }
        .seat-tooltip { /* Simple tooltip for booked seats - will be populated by JS */
            visibility: hidden; background-color: #333; color: #fff; text-align: center;
            border-radius: 4px; padding: 5px 8px; position: absolute; z-index: 100;
            font-size: 0.8rem; white-space: nowrap; bottom: 125%; left: 50%;
            transform: translateX(-50%); opacity: 0; transition: opacity 0.3s;
        }
        .seat.booked:hover .seat-tooltip { visibility: visible; opacity: 1; }


        /* Attendee List Table */
        .attendee-table-container { overflow-x: auto; margin-top:15px; }
        .attendee-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        .attendee-table th, .attendee-table td { border: 1px solid #dee2e6; padding: 8px 10px; text-align: left; }
        .attendee-table th { background-color: #e9ecef; color: #004170; font-weight: 600; }
        .attendee-table tbody tr:nth-child(odd) { background-color: #f8f9fa; }
        .attendee-table tbody tr:hover { background-color: #e2e6ea; }


        @media (max-width: 768px) {
            h1 { font-size: 1.8rem; } h2 { font-size: 1.5rem; }
            .container { width: 95%; }
            .section-container, .form-container { padding: 20px 15px; } /* .form-container is legacy, use section-container */
            legend { font-size: 1.15rem; }
            .form-group-inline { flex-direction: column; gap: 0; }
            .form-group-inline .form-group { margin-bottom: 1.25rem; min-width: 100%; }
            .form-actions { justify-content: center; }
            .form-actions .btn { width: 100%; margin-bottom: 0.5rem; }
            .form-actions .btn:last-child { margin-bottom: 0; }
            .lang-toggle { font-size: 0.85rem; margin-top: 0.5rem; }

            .main-nav { display: none; flex-direction: column; position: absolute; top: 100%; left: 0; width: 100%; background-color: #005A9C; box-shadow: 0 2px 4px rgba(0,0,0,0.1); padding: 10px 0; }
            .main-nav.active { display: flex; }
            .main-nav ul { flex-direction: column; width: 100%; }
            .main-nav li { margin: 0; text-align: center; }
            .main-nav li a { display: block; padding: 10px; border-bottom: 1px solid #004170; }
            .main-nav li:last-child a { border-bottom: none; }
            .mobile-nav-toggle { display: block; }

            .seat { width:25px; height:25px; font-size:0.6rem; }
            .dashboard-grid { grid-template-columns: 1fr; } /* Stack cards on mobile */
        }
        @media (max-width: 480px) {
            html { font-size: 15px; }
            label, input[type="text"], input[type="password"],
            input[type="date"], input[type="time"], input[type="number"], textarea, select { font-size: 0.95rem; padding: 0.6rem 0.8rem;}
            .section-container { padding: 15px 10px; }
            .form-actions .btn { padding: 0.7rem 1.2rem; }
            .seat { width:22px; height:22px; font-size:0.55rem; }
        }
    </style>
</head>
<body>

    <div id="app-header">
        </div>

    <main class="container">
        <h1 class="main-title" data-fr="Modifier un Événement" data-en="Edit Event">Modifier un Événement</h1>
        <p class="lang-toggle">
            <a href="#" onclick="inlineChangeLang('fr'); return false;" class="lang-link active" id="lang-fr-edit">FR</a> |
            <a href="#" onclick="inlineChangeLang('en'); return false;" class="lang-link" id="lang-en-edit">EN</a>
        </p>

        <div id="formGeneralMessageInline" class="form-message" style="display: none;"></div>

        <section id="authSection" class="section-container">
            <h2 data-fr="Authentification Requise" data-en="Authentication Required">Authentification Requise</h2>
            <form id="authEventForm">
                <div class="form-group">
                    <label for="authEventId" data-fr="ID de l'Événement :" data-en="Event ID:">ID de l'Événement :</label>
                    <input type="text" id="authEventId" name="authEventId" required>
                </div>
                <div class="form-group">
                    <label for="authAdminPassword" data-fr="Mot de passe Administrateur :" data-en="Admin Password:">Mot de passe Administrateur :</label>
                    <input type="password" id="authAdminPassword" name="authAdminPassword" required>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary"><i class="fas fa-sign-in-alt"></i> <span data-fr="Charger l'Événement" data-en="Load Event">Charger l'Événement</span></button>
                </div>
            </form>
        </section>

        <div id="eventDashboardAndEditSection" style="display:none;">
            <h2 id="loadedEventNameDisplay" style="text-align:center; color: #005A9C; margin-bottom:1.5rem;"></h2>

            <section id="eventDashboardSection" class="section-container">
                <h3 data-fr="Tableau de Bord de l'Événement" data-en="Event Dashboard">Tableau de Bord de l'Événement</h3>
                <div class="dashboard-grid">
                    <div class="dashboard-card">
                        <h4 data-fr="Statistiques Générales" data-en="Overall Statistics">Statistiques Générales</h4>
                        <p><span class="stat-label" data-fr="Capacité Totale :" data-en="Total Capacity:">Capacité Totale :</span> <span id="totalCapacity" class="stat-value">0</span></p>
                        <p><span class="stat-label" data-fr="Inscrits :" data-en="Registered:">Inscrits :</span> <span id="totalRegistered" class="stat-value">0</span></p>
                        <p><span class="stat-label" data-fr="Places Restantes :" data-en="Seats Remaining:">Places Restantes :</span> <span id="seatsRemaining" class="stat-value">0</span></p>
                        <div class="progress-bar-container">
                            <div class="progress-bar" id="capacityProgressBar" style="width: 0%;"><span id="capacityPercentage">0%</span></div>
                        </div>
                    </div>
                    <div class="dashboard-card">
                        <h4 data-fr="Répartition des Menus" data-en="Menu Breakdown">Répartition des Menus</h4>
                        <div id="menuStatsContainer">
                            <p data-fr="Aucune donnée de menu pour le moment." data-en="No menu data yet.">Aucune donnée de menu pour le moment.</p>
                        </div>
                    </div>
                     <div class="dashboard-card" id="paymentStatsCard" style="display:none;">
                        <h4 data-fr="Statistiques de Paiement" data-en="Payment Statistics">Statistiques de Paiement</h4>
                        <p><span class="stat-label" data-fr="Ont indiqué 'Payé' :" data-en="Indicated 'Paid':">Ont indiqué 'Payé' :</span> <span id="countPaidYes" class="stat-value">0</span></p>
                        <p><span class="stat-label" data-fr="Ont indiqué 'Non Payé' :" data-en="Indicated 'Not Paid':">Ont indiqué 'Non Payé' :</span> <span id="countPaidNo" class="stat-value">0</span></p>
                    </div>
                </div>
                <div>
                    <h4 data-fr="Visualisation des Tables et Sièges" data-en="Table & Seat Visualization">Visualisation des Tables et Sièges</h4>
                    <div id="tableVisualization">
                        <p data-fr="Chargez un événement pour voir la disposition." data-en="Load an event to see the layout.">Chargez un événement pour voir la disposition.</p>
                    </div>
                </div>
            </section>

            <section id="editEventFormSection" class="section-container">
                <h3 data-fr="Modifier les Détails de l'Événement" data-en="Edit Event Details">Modifier les Détails de l'Événement</h3>
                <form id="editEventForm" novalidate>
                    <input type="hidden" id="editingEventId" name="editingEventId">
                    <fieldset>
                        <legend data-fr="Détails de l'Événement" data-en="Event Details">Détails de l'Événement</legend>
                        <div class="form-group">
                            <label for="eventNameEdit" data-fr="Nom de l'événement :" data-en="Event Name:">Nom de l'événement :</label>
                            <input type="text" id="eventNameEdit" name="eventName" required maxlength="100">
                        </div>
                        <div class="form-group">
                            <label for="eventDescriptionEdit" data-fr="Description de l'événement :" data-en="Event Description:">Description de l'événement :</label>
                            <textarea id="eventDescriptionEdit" name="eventDescription" rows="4" maxlength="250" required></textarea>
                            <small id="charCountEdit" class="form-text" data-fr="250 caractères restants" data-en="250 characters remaining">250 caractères restants</small>
                        </div>
                        <div class="form-group-inline">
                            <div class="form-group"><label for="eventStartDateEdit" data-fr="Date de début :" data-en="Start Date:">Date de début :</label><input type="date" id="eventStartDateEdit" name="eventStartDate" required></div>
                            <div class="form-group"><label for="eventStartTimeEdit" data-fr="Heure de début :" data-en="Start Time:">Heure de début :</label><input type="time" id="eventStartTimeEdit" name="eventStartTime" required></div>
                        </div>
                        <div class="form-group-inline">
                            <div class="form-group"><label for="eventEndDateEdit" data-fr="Date de fin :" data-en="End Date:">Date de fin :</label><input type="date" id="eventEndDateEdit" name="eventEndDate" required></div>
                            <div class="form-group"><label for="eventEndTimeEdit" data-fr="Heure de fin :" data-en="End Time:">Heure de fin :</label><input type="time" id="eventEndTimeEdit" name="eventEndTime" required></div>
                        </div>
                        <div class="form-group-inline">
                            <div class="form-group"><label for="registrationDeadlineDateEdit" data-fr="Date limite d'inscription :" data-en="Registration Deadline Date:">Date limite d'inscription :</label><input type="date" id="registrationDeadlineDateEdit" name="registrationDeadlineDate" required></div>
                            <div class="form-group"><label for="registrationDeadlineTimeEdit" data-fr="Heure limite d'inscription :" data-en="Registration Deadline Time:">Heure limite d'inscription :</label><input type="time" id="registrationDeadlineTimeEdit" name="registrationDeadlineTime" required></div>
                        </div>
                    </fieldset>
                    <fieldset>
                        <legend data-fr="Configuration de la Salle" data-en="Venue Setup">Configuration de la Salle</legend>
                        <div class="form-group-inline">
                            <div class="form-group"><label for="numTablesEdit" data-fr="Nombre de tables :" data-en="Number of Tables:">Nombre de tables :</label><input type="number" id="numTablesEdit" name="numTables" min="1" required></div>
                            <div class="form-group"><label for="chairsPerTableEdit" data-fr="Chaises par table (1-50) :" data-en="Chairs per Table (1-50):">Chaises par table (1-50) :</label><input type="number" id="chairsPerTableEdit" name="chairsPerTable" min="1" max="50" required></div>
                        </div>
                         <small class="form-text" data-fr="Attention: Réduire la capacité peut affecter les inscriptions existantes si la nouvelle capacité est inférieure au nombre d'inscrits." data-en="Caution: Reducing capacity may affect existing registrations if the new capacity is less than the number of registered attendees.">Attention: Réduire la capacité peut affecter les inscriptions existantes.</small>
                    </fieldset>
                    <fieldset>
                        <legend data-fr="Options de Menu" data-en="Menu Options">Options de Menu</legend>
                        <div class="form-group">
                            <label for="numMenusEdit" data-fr="Nombre de menus proposés (0-5) :" data-en="Number of Menu Options (0-5):">Nombre de menus proposés (0-5) :</label>
                            <select id="numMenusEdit" name="numMenus">
                                <option value="0" data-fr="Aucun menu" data-en="No menus">0</option> <option value="1">1</option> <option value="2">2</option> <option value="3">3</option> <option value="4">4</option> <option value="5">5</option>
                            </select>
                        </div>
                        <div id="menuNameInputsContainerEdit"></div>
                    </fieldset>
                    <fieldset>
                        <legend data-fr="Options Avancées" data-en="Advanced Options">Options Avancées</legend>
                         <div class="form-group">
                            <label for="maxRegistrationsPerUserEdit" data-fr="Inscriptions max par utilisateur (0 = illimité) :" data-en="Max registrations per user (0 = unlimited):">Inscriptions max par utilisateur :</label>
                            <input type="number" id="maxRegistrationsPerUserEdit" name="maxRegistrationsPerUser" min="0" required>
                        </div>
                        <div class="form-group form-group-checkbox">
                            <input type="checkbox" id="enableWaitlistEdit" name="enableWaitlist">
                            <label for="enableWaitlistEdit" data-fr="Activer la liste d'attente si complet ?" data-en="Enable waitlist if event is full?">Activer la liste d'attente si complet ?</label>
                        </div>
                        <div class="form-group">
                            <label for="eventBadgeEdit" data-fr="Choisir un badge :" data-en="Choose a badge:">Choisir un badge :</label>
                            <select id="eventBadgeEdit" name="eventBadge">
                                <option value="none" data-fr="Aucun" data-en="None">Aucun</option><option value="new" data-fr="Nouveau" data-en="New">Nouveau</option><option value="popular" data-fr="Populaire" data-en="Popular">Populaire</option><option value="special" data-fr="Spécial" data-en="Special">Spécial</option><option value="promo" data-fr="Promotion" data-en="Promotion">Promotion</option><option value="soon" data-fr="Bientôt Complet" data-en="Nearly Full">Bientôt Complet</option>
                            </select>
                        </div>
                    </fieldset>
                    <fieldset>
                        <legend data-fr="Tarification" data-en="Pricing">Tarification</legend>
                        <div class="form-group form-group-checkbox">
                            <input type="checkbox" id="isPaidEventEdit" name="isPaidEvent">
                            <label for="isPaidEventEdit" data-fr="Cet événement est-il payant ?" data-en="Is this a paid event?">Cet événement est-il payant ?</label>
                        </div>
                        <div class="form-group" id="eventPriceGroupEdit" style="display: none;">
                            <label for="eventPriceEdit" data-fr="Prix de l'événement (€) :" data-en="Event Price (€):">Prix de l'événement (€) :</label>
                            <input type="number" id="eventPriceEdit" name="eventPrice" min="0" step="0.01" placeholder="Ex: 25.50">
                        </div>
                    </fieldset>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> <span data-fr="Sauvegarder les Modifications" data-en="Save Changes">Sauvegarder</span></button>
                        <button type="button" id="deleteEventButton" class="btn btn-danger"><i class="fas fa-trash-alt"></i> <span data-fr="Supprimer l'Événement" data-en="Delete Event">Supprimer</span></button>
                        <button type="button" id="cancelEditButton" class="btn btn-secondary"><i class="fas fa-times"></i> <span data-fr="Annuler" data-en="Cancel">Annuler</span></button>
                    </div>
                </form>
            </section>

            <section id="attendeeManagementSection" class="section-container">
                <h3 data-fr="Gestion des Inscriptions" data-en="Attendee Management">Gestion des Inscriptions</h3>
                <button id="exportCsvButton" class="btn btn-info" style="margin-bottom: 15px;"><i class="fas fa-file-csv"></i> <span data-fr="Exporter en CSV" data-en="Export to CSV">Exporter en CSV</span></button>
                <div class="attendee-table-container">
                    <table class="attendee-table">
                        <thead>
                            <tr>
                                <th data-fr="Nom" data-en="Name">Nom</th>
                                <th data-fr="Email" data-en="Email">Email</th>
                                <th data-fr="Téléphone" data-en="Phone">Téléphone</th>
                                <th data-fr="Menu" data-en="Menu">Menu</th>
                                <th data-fr="Date d'inscription" data-en="Registration Date">Date d'inscription</th>
                                <th data-fr="Payé ?" data-en="Paid?">Payé ?</th>
                                </tr>
                        </thead>
                        <tbody id="attendeeListBody">
                            <tr><td colspan="6" data-fr="Aucun inscrit pour le moment." data-en="No attendees yet.">Aucun inscrit pour le moment.</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

             <section id="waitlistManagementSection" class="section-container" style="display:none;">
                <h3 data-fr="Liste d'Attente" data-en="Waitlist">Liste d'Attente</h3>
                <p><span data-fr="Personnes en attente :" data-en="People on waitlist:">Personnes en attente :</span> <strong id="waitlistCount">0</strong></p>
                <div class="attendee-table-container">
                     <table class="attendee-table">
                        <thead>
                            <tr>
                                <th data-fr="Nom" data-en="Name">Nom</th>
                                <th data-fr="Email" data-en="Email">Email</th>
                                <th data-fr="Téléphone" data-en="Phone">Téléphone</th>
                                <th data-fr="Date d'ajout" data-en="Date Added">Date d'ajout</th>
                            </tr>
                        </thead>
                        <tbody id="waitlistBody">
                             <tr><td colspan="4" data-fr="La liste d'attente est vide." data-en="Waitlist is empty.">La liste d'attente est vide.</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>
        </div> </main>

    <div id="app-footer">
        </div>

    <script src="src/hf.js"></script>
    <script>
    // --- MonRdvFacile - Inline JS for edit-event.html ---
    document.addEventListener('DOMContentLoaded', function() {
        const WORKER_BASE_URL = 'https://monrdvfacile-api.qmpro.workers.dev/api/events'; // Ensure this is correct
        let currentAuthenticatedPassword = null;
        let currentlyEditingEventId = null;
        let currentLoadedEventFullData = null; // Store the entire event object including registrations

        // --- Language Switching Logic ---
        let currentLangEdit = 'fr';
        const translatableItemsEdit = [];

        function queryTranslatableItemsEdit() {
            translatableItemsEdit.length = 0;
            document.querySelectorAll('[data-fr], [data-en], [data-fr-placeholder], [data-en-placeholder]').forEach(el => {
                 const item = {
                    element: el,
                    frText: el.dataset.fr,
                    enText: el.dataset.en,
                    frPlaceholder: el.dataset.frPlaceholder,
                    enPlaceholder: el.dataset.enPlaceholder,
                    isTitle: el.tagName === 'TITLE',
                    isButtonSpan: el.tagName === 'BUTTON' && el.querySelector('span'),
                    isDirectButton: el.tagName === 'BUTTON' && !el.querySelector('span') && (el.dataset.fr || el.dataset.en)
                };
                if (!item.frText && !item.isPlaceholder && !(item.isButtonSpan || item.isDirectButton)) item.frText = el.textContent.trim();
                if (!item.enText && !item.isPlaceholder && !(item.isButtonSpan || item.isDirectButton)) item.enText = el.textContent.trim();
                if (!item.frPlaceholder && el.placeholder) item.frPlaceholder = el.placeholder;
                if (!item.enPlaceholder && el.placeholder) item.enPlaceholder = el.placeholder;
                translatableItemsEdit.push(item);
            });
        }

        function updateUIForLanguageEdit(lang) {
            currentLangEdit = lang;
            document.documentElement.lang = lang;
            translatableItemsEdit.forEach(item => {
                const text = lang === 'fr' ? item.frText : item.enText;
                const placeholderText = lang === 'fr' ? item.frPlaceholder : item.enPlaceholder;

                if (item.isTitle) { if(text) item.element.textContent = text; }
                else if (item.frPlaceholder || item.enPlaceholder) { if(placeholderText) item.element.placeholder = placeholderText; }
                else if (item.isButtonSpan) { const span = item.element.querySelector('span'); if (span && text) span.textContent = text; }
                else if (item.isDirectButton) {
                    const icon = item.element.querySelector('i');
                    if (icon) { item.element.innerHTML = icon.outerHTML + " " + (text || ""); }
                    else if (text) { item.element.textContent = text; }
                } else { if(text) item.element.textContent = text; }
            });
            document.querySelectorAll('.lang-link').forEach(link => link.classList.remove('active'));
            const activeLink = document.getElementById(`lang-${lang}-edit`);
            if (activeLink) activeLink.classList.add('active');
            try { localStorage.setItem('preferredLang', lang); } catch (e) { console.warn("localStorage unavailable for lang pref."); }

            if (currentLoadedEventFullData) { // If data is loaded, re-render dynamic parts
                if (eventDescriptionTextareaEdit) eventDescriptionTextareaEdit.dispatchEvent(new Event('input')); // char count
                if (numMenusSelectEdit) generateMenuInputsEdit(parseInt(numMenusSelectEdit.value, 10), currentLoadedEventFullData.eventDetails);
                // Re-render dashboard elements that might have language-dependent text
                renderDashboard(currentLoadedEventFullData.eventDetails, currentLoadedEventFullData.registrations);
                renderAttendeeList(currentLoadedEventFullData.registrations);
                if(currentLoadedEventFullData.eventDetails.enableWaitlist) renderWaitlist(currentLoadedEventFullData.waitlist);
            }
        }
        window.inlineChangeLang = function(lang) { if (lang !== currentLangEdit) { updateUIForLanguageEdit(lang); } };
        function detectLanguagePreferenceEdit() { /* ... (same as create-event) ... */
            try {const storedLang = localStorage.getItem('preferredLang'); if (storedLang && (storedLang === 'fr' || storedLang === 'en')) return storedLang;} catch (e) {}
            const browserLang = navigator.language || navigator.userLanguage; if (browserLang && browserLang.toLowerCase().startsWith('en')) return 'en'; return 'fr';
        }
        // --- END Language ---

        const authSection = document.getElementById('authSection');
        const eventDashboardAndEditSection = document.getElementById('eventDashboardAndEditSection');
        const authEventForm = document.getElementById('authEventForm');
        const editEventForm = document.getElementById('editEventForm');
        const messageDivInline = document.getElementById('formGeneralMessageInline');
        const loadedEventNameDisplay = document.getElementById('loadedEventNameDisplay');

        // Form fields (cache them)
        const eventNameEdit = document.getElementById('eventNameEdit');
        const eventDescriptionTextareaEdit = document.getElementById('eventDescriptionEdit');
        const charCountDisplayEdit = document.getElementById('charCountEdit');
        const eventStartDateEdit = document.getElementById('eventStartDateEdit');
        const eventStartTimeEdit = document.getElementById('eventStartTimeEdit');
        const eventEndDateEdit = document.getElementById('eventEndDateEdit');
        const eventEndTimeEdit = document.getElementById('eventEndTimeEdit');
        const registrationDeadlineDateEdit = document.getElementById('registrationDeadlineDateEdit');
        const registrationDeadlineTimeEdit = document.getElementById('registrationDeadlineTimeEdit');
        const numTablesEdit = document.getElementById('numTablesEdit');
        const chairsPerTableEdit = document.getElementById('chairsPerTableEdit');
        const numMenusSelectEdit = document.getElementById('numMenusEdit');
        const menuNameInputsContainerEdit = document.getElementById('menuNameInputsContainerEdit');
        const isPaidEventCheckboxEdit = document.getElementById('isPaidEventEdit');
        const eventPriceGroupEdit = document.getElementById('eventPriceGroupEdit');
        const eventPriceInputEdit = document.getElementById('eventPriceEdit');
        const eventBadgeEdit = document.getElementById('eventBadgeEdit');
        const maxRegistrationsPerUserEdit = document.getElementById('maxRegistrationsPerUserEdit');
        const enableWaitlistEdit = document.getElementById('enableWaitlistEdit');

        // Dashboard elements
        const totalCapacityEl = document.getElementById('totalCapacity');
        const totalRegisteredEl = document.getElementById('totalRegistered');
        const seatsRemainingEl = document.getElementById('seatsRemaining');
        const capacityProgressBarEl = document.getElementById('capacityProgressBar');
        const capacityPercentageEl = document.getElementById('capacityPercentage');
        const menuStatsContainerEl = document.getElementById('menuStatsContainer');
        const paymentStatsCardEl = document.getElementById('paymentStatsCard');
        const countPaidYesEl = document.getElementById('countPaidYes');
        const countPaidNoEl = document.getElementById('countPaidNo');
        const tableVisualizationEl = document.getElementById('tableVisualization');
        const attendeeListBodyEl = document.getElementById('attendeeListBody');
        const exportCsvButton = document.getElementById('exportCsvButton');
        const waitlistManagementSectionEl = document.getElementById('waitlistManagementSection');
        const waitlistCountEl = document.getElementById('waitlistCount');
        const waitlistBodyEl = document.getElementById('waitlistBody');


        const deleteEventButton = document.getElementById('deleteEventButton');
        const cancelEditButton = document.getElementById('cancelEditButton');

        const messagesEdit = { /* ... (same as create-event, but specific to edit contexts) ... */
            eventIdRequired: { fr: "L'ID de l'événement est requis.", en: "Event ID is required." },
            passwordRequired: { fr: "Le mot de passe est requis.", en: "Password is required." },
            authError: { fr: "Authentification échouée. Vérifiez l'ID et le mot de passe.", en: "Authentication failed. Check Event ID and password."},
            eventLoaded: { fr: "Événement chargé.", en: "Event loaded." },
            changesSaved: { fr: "Modifications sauvegardées avec succès !", en: "Changes saved successfully!" },
            eventDeleted: { fr: "Événement supprimé avec succès.", en: "Event deleted successfully." },
            confirmDelete: { fr: "Êtes-vous sûr de vouloir supprimer cet événement ? Cette action est irréversible.", en: "Are you sure you want to delete this event? This action is irreversible." },
            apiError: { fr: "Erreur de communication avec le serveur.", en: "API communication error." },
            formErrors: { fr: "Veuillez corriger les erreurs dans le formulaire.", en: "Please correct the errors in the form." },
            charRemaining: { fr: "{count} caractères restants", en: "{count} characters remaining" },
            menuLabel: { fr: "Nom du Menu {letter}:", en: "Menu Name {letter}:" },
            menuPlaceholder: { fr: "Détail du Menu {letter}", en: "Details for Menu {letter}" },
            endDateBeforeStart: { fr: "La date/heure de fin ne peut être antérieure à la date/heure de début.", en: "End date/time cannot be before start date/time."},
            deadlineAfterStart: { fr: "La date/heure limite d'inscription ne peut être postérieure à la date/heure de début.", en: "Registration deadline cannot be after the event start date/time."},
            noAttendees: {fr: "Aucun inscrit pour le moment.", en: "No attendees yet."},
            waitlistEmpty: {fr: "La liste d'attente est vide.", en: "Waitlist is empty."},
            tableLabel: {fr: "Table", en: "Table"},
            seatLabel: {fr: "Siège", en: "Seat"},
            attendeeName: {fr: "Nom", en: "Name"},
            attendeeEmail: {fr: "Email", en: "Email"},
            attendeeMenu: {fr: "Menu", en: "Menu"},
            attendeePaid: {fr: "Payé", en: "Paid"},
            statusYes: {fr: "Oui", en: "Yes"},
            statusNo: {fr: "Non", en: "No"},
        };

        function getMessageEdit(key, replacements = {}) { /* ... (same as create-event) ... */
             let messageSet = messagesEdit[key];
             if (!messageSet) return `Missing translation for Edit: ${key}`;
             let message = messageSet[currentLangEdit] || messageSet['fr'];
             for (const placeholder in replacements) { message = message.replace(`{${placeholder}}`, replacements[placeholder]); }
             return message;
        }
        function displayMessageInline(message, type = 'error') { /* ... (same) ... */
             messageDivInline.innerHTML = message; messageDivInline.className = `form-message form-message-${type}`; messageDivInline.style.display = 'block';
        }
        function clearMessageInline() { /* ... (same) ... */
            messageDivInline.innerHTML = ''; messageDivInline.style.display = 'none'; messageDivInline.className = 'form-message';
        }

        if (eventDescriptionTextareaEdit) { /* ... char counter (same) ... */
             const maxLengthEdit = parseInt(eventDescriptionTextareaEdit.getAttribute('maxlength'), 10);
             eventDescriptionTextareaEdit.addEventListener('input', function() {
                const currentLength = this.value.length; const remaining = maxLengthEdit - currentLength;
                charCountDisplayEdit.textContent = getMessageEdit('charRemaining', {count: remaining});
                charCountDisplayEdit.style.color = remaining < 0 ? 'red' : '#6C757D';
             });
        }

        function generateMenuInputsEdit(count, eventData = {}) { /* ... (same, but uses 'Edit' ids and populates with eventData.menuNames) ... */
            menuNameInputsContainerEdit.innerHTML = '';
            if (count === 0 || count === "0") return;
            const menuArray = eventData.menuNames || []; // Handle if menuNames is undefined

            for (let i = 0; i < count; i++) {
                const menuLetter = String.fromCharCode(65 + i);
                const formGroup = document.createElement('div'); formGroup.classList.add('form-group');
                const label = document.createElement('label'); label.setAttribute('for', `menuNameEdit${i}`); label.textContent = getMessageEdit('menuLabel', {letter: menuLetter});
                const input = document.createElement('input'); input.type = 'text'; input.id = `menuNameEdit${i}`; input.name = `menuName${i}`; input.required = true; input.maxLength = 70;
                input.placeholder = getMessageEdit('menuPlaceholder', {letter: menuLetter});
                if (menuArray[i]) { input.value = menuArray[i]; } // Populate from array
                formGroup.appendChild(label); formGroup.appendChild(input); menuNameInputsContainerEdit.appendChild(formGroup);
            }
        }
        if (numMenusSelectEdit) { /* ... (same, but calls with currentLoadedEventFullData.eventDetails for repopulation) ... */
            numMenusSelectEdit.addEventListener('change', function() { generateMenuInputsEdit(parseInt(this.value, 10), currentLoadedEventFullData ? currentLoadedEventFullData.eventDetails : {}); });
        }

        if (isPaidEventCheckboxEdit) { /* ... (same) ... */
            isPaidEventCheckboxEdit.addEventListener('change', function() {
                eventPriceGroupEdit.style.display = this.checked ? 'block' : 'none';
                eventPriceInputEdit.required = this.checked;
                if (!this.checked) eventPriceInputEdit.value = '';
            });
        }

        function validateDatesEdit() { /* ... (same logic, using 'Edit' ids) ... */
            let isValid = true;
            const startDateTime = new Date(`${eventStartDateEdit.value}T${eventStartTimeEdit.value || "00:00"}`);
            const endDateTime = new Date(`${eventEndDateEdit.value}T${eventEndTimeEdit.value || "00:00"}`);
            const deadlineDateTime = new Date(`${registrationDeadlineDateEdit.value}T${registrationDeadlineTimeEdit.value || "00:00"}`);
            
            eventEndDateEdit.setCustomValidity(""); registrationDeadlineDateEdit.setCustomValidity("");

            if (eventStartDateEdit.value && eventEndDateEdit.value && eventStartTimeEdit.value && eventEndTimeEdit.value && endDateTime <= startDateTime) {
                eventEndDateEdit.setCustomValidity(getMessageEdit('endDateBeforeStart')); isValid = false;
            }
            if (eventStartDateEdit.value && registrationDeadlineDateEdit.value && eventStartTimeEdit.value && registrationDeadlineTimeEdit.value && deadlineDateTime >= startDateTime) {
                registrationDeadlineDateEdit.setCustomValidity(getMessageEdit('deadlineAfterStart')); isValid = false;
            }
             return isValid;
        }
        // Add event listeners for date validation
         ['eventStartDateEdit', 'eventStartTimeEdit', 'eventEndDateEdit', 'eventEndTimeEdit', 'registrationDeadlineDateEdit', 'registrationDeadlineTimeEdit'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.addEventListener('change', validateDatesEdit);
        });


        function populateEditForm(eventDetails) {
            document.getElementById('editingEventId').value = eventDetails.id;
            loadedEventNameDisplay.textContent = eventDetails.eventName;
            eventNameEdit.value = eventDetails.eventName || '';
            eventDescriptionTextareaEdit.value = eventDetails.eventDescription || '';
            eventStartDateEdit.value = eventDetails.eventStartDate || '';
            eventStartTimeEdit.value = eventDetails.eventStartTime || '';
            eventEndDateEdit.value = eventDetails.eventEndDate || '';
            eventEndTimeEdit.value = eventDetails.eventEndTime || '';
            registrationDeadlineDateEdit.value = eventDetails.registrationDeadlineDate || '';
            registrationDeadlineTimeEdit.value = eventDetails.registrationDeadlineTime || '';
            numTablesEdit.value = eventDetails.numTables || '1';
            chairsPerTableEdit.value = eventDetails.chairsPerTable || '4';
            eventBadgeEdit.value = eventDetails.eventBadge || 'none';
            maxRegistrationsPerUserEdit.value = eventDetails.maxRegistrationsPerUser !== undefined ? eventDetails.maxRegistrationsPerUser : '0';
            enableWaitlistEdit.checked = eventDetails.enableWaitlist === 1 || eventDetails.enableWaitlist === true;

            isPaidEventCheckboxEdit.checked = eventDetails.isPaidEvent === 1 || eventDetails.isPaidEvent === true;
            isPaidEventCheckboxEdit.dispatchEvent(new Event('change')); // Trigger display of price field
            if (isPaidEventCheckboxEdit.checked) {
                eventPriceInputEdit.value = eventDetails.eventPrice !== null ? eventDetails.eventPrice : '';
            }

            numMenusSelectEdit.value = eventDetails.numMenus !== null ? String(eventDetails.numMenus) : '0';
            generateMenuInputsEdit(parseInt(numMenusSelectEdit.value, 10), eventDetails); // eventDetails should contain menuNames array

            if (eventDescriptionTextareaEdit) eventDescriptionTextareaEdit.dispatchEvent(new Event('input'));
        }

        // --- DASHBOARD RENDERING FUNCTIONS ---
        function renderDashboard(eventDetails, registrations = []) {
            const numTables = parseInt(eventDetails.numTables, 10) || 0;
            const chairsPerTable = parseInt(eventDetails.chairsPerTable, 10) || 0;
            const totalCapacity = numTables * chairsPerTable;
            const totalRegistered = registrations.length;
            const seatsRemaining = totalCapacity - totalRegistered;
            const capacityPercent = totalCapacity > 0 ? Math.min(100, Math.round((totalRegistered / totalCapacity) * 100)) : 0;

            totalCapacityEl.textContent = totalCapacity;
            totalRegisteredEl.textContent = totalRegistered;
            seatsRemainingEl.textContent = seatsRemaining < 0 ? 0 : seatsRemaining; // Cannot be negative
            capacityProgressBarEl.style.width = `${capacityPercent}%`;
            capacityPercentageEl.textContent = `${capacityPercent}%`;
            if(capacityPercent >= 90) capacityProgressBarEl.style.backgroundColor = '#dc3545'; // Red
            else if (capacityPercent >=70) capacityProgressBarEl.style.backgroundColor = '#ffc107'; // Orange
            else capacityProgressBarEl.style.backgroundColor = '#005A9C'; // Blue


            // Menu Stats
            menuStatsContainerEl.innerHTML = '';
            if (eventDetails.numMenus > 0 && eventDetails.menuNames && eventDetails.menuNames.length > 0) {
                const menuCounts = {};
                eventDetails.menuNames.forEach(name => menuCounts[name] = 0);
                registrations.forEach(reg => {
                    if (reg.menuChoice && menuCounts.hasOwnProperty(reg.menuChoice)) {
                        menuCounts[reg.menuChoice]++;
                    }
                });

                for (const menuName in menuCounts) {
                    const count = menuCounts[menuName];
                    const percentage = totalRegistered > 0 ? Math.round((count / totalRegistered) * 100) : 0;
                    const p = document.createElement('p');
                    p.innerHTML = `${menuName}: <strong class="stat-value" style="font-size:1.2rem;">${count}</strong> (${percentage}%)`;
                    const progContainer = document.createElement('div');
                    progContainer.className = 'progress-bar-container';
                    const progBar = document.createElement('div');
                    progBar.className = 'progress-bar';
                    progBar.style.width = `${percentage}%`;
                    progBar.style.backgroundColor = '#17A2B8'; // Teal for menu stats
                    progBar.textContent = `${percentage}%`;
                    progContainer.appendChild(progBar);
                    menuStatsContainerEl.appendChild(p);
                    menuStatsContainerEl.appendChild(progContainer);
                }
            } else {
                menuStatsContainerEl.innerHTML = `<p data-fr="Aucun menu configuré ou aucune inscription." data-en="No menus configured or no registrations.">${getMessageEdit('noMenuData') || 'No menu data.'}</p>`;
            }

            // Payment Stats
            if (eventDetails.isPaidEvent) {
                paymentStatsCardEl.style.display = 'block';
                let paidYes = 0;
                let paidNo = 0;
                registrations.forEach(reg => {
                    if (reg.paidStatus === 'yes' || reg.paidStatus === 1 || reg.paidStatus === true) paidYes++; // Adapt based on how paidStatus is stored
                    else if (reg.paidStatus === 'no' || reg.paidStatus === 0 || reg.paidStatus === false) paidNo++;
                });
                countPaidYesEl.textContent = paidYes;
                countPaidNoEl.textContent = paidNo;
            } else {
                paymentStatsCardEl.style.display = 'none';
            }

            // Table Visualization
            renderTableVisualization(numTables, chairsPerTable, registrations);
        }

        function renderTableVisualization(numTables, chairsPerTable, registrations = []) {
            tableVisualizationEl.innerHTML = '';
            if (numTables === 0 || chairsPerTable === 0) {
                tableVisualizationEl.innerHTML = `<p data-fr="Configurez les tables et chaises pour voir la visualisation." data-en="Configure tables and chairs to see visualization.">${getMessageEdit('configureTables') || 'Configure tables first.'}</p>`;
                return;
            }

            // Create a map for quick lookup of booked seats: "T{tableIndex}-S{seatIndex}" -> registration
            const bookedSeatsMap = new Map();
            registrations.forEach(reg => {
                // Assuming registrations might have tableNumber and seatNumber (1-indexed from DB/user input)
                // If not, this part needs adjustment based on how seats are assigned/tracked
                if (reg.tableNumber !== undefined && reg.seatNumber !== undefined) {
                    bookedSeatsMap.set(`T${reg.tableNumber -1}-S${reg.seatNumber -1}`, reg);
                }
            });


            for (let t = 0; t < numTables; t++) {
                const tableDiv = document.createElement('div');
                tableDiv.className = 'event-table';
                const tableTitle = document.createElement('div');
                tableTitle.className = 'event-table-title';
                tableTitle.textContent = `${getMessageEdit('tableLabel')} ${t + 1}`;
                tableDiv.appendChild(tableTitle);

                const seatsGrid = document.createElement('div');
                seatsGrid.className = 'seats-grid';
                // Adjust columns for better layout, e.g., max 10 chairs wide then wrap
                const maxCols = Math.min(chairsPerTable, 10);
                seatsGrid.style.gridTemplateColumns = `repeat(${maxCols}, 1fr)`;

                for (let s = 0; s < chairsPerTable; s++) {
                    const seatDiv = document.createElement('div');
                    seatDiv.className = 'seat';
                    seatDiv.textContent = s + 1; // Seat number

                    const seatKey = `T${t}-S${s}`;
                    const registration = bookedSeatsMap.get(seatKey);

                    if (registration) {
                        seatDiv.classList.add('booked');
                        seatDiv.title = `${getMessageEdit('attendeeName')}: ${registration.name}\n${getMessageEdit('attendeeMenu')}: ${registration.menuChoice}`;
                        // Simple tooltip
                        const tooltip = document.createElement('span');
                        tooltip.className = 'seat-tooltip';
                        tooltip.innerHTML = `<strong>${registration.name}</strong><br>${getMessageEdit('attendeeMenu')}: ${registration.menuChoice}<br>${getMessageEdit('attendeeEmail')}: ${registration.email}`;
                        if(currentLoadedEventFullData.eventDetails.isPaidEvent){
                            tooltip.innerHTML += `<br>${getMessageEdit('attendeePaid')}: ${registration.paidStatus === 'yes' || registration.paidStatus === 1 ? getMessageEdit('statusYes') : getMessageEdit('statusNo')}`;
                        }
                        seatDiv.appendChild(tooltip);

                    } else {
                        seatDiv.classList.add('available');
                    }
                    seatsGrid.appendChild(seatDiv);
                }
                tableDiv.appendChild(seatsGrid);
                tableVisualizationEl.appendChild(tableDiv);
            }
        }

        function renderAttendeeList(registrations = []) {
            attendeeListBodyEl.innerHTML = '';
            if (registrations.length === 0) {
                const tr = attendeeListBodyEl.insertRow();
                const td = tr.insertCell();
                td.colSpan = 6; // Number of columns
                td.textContent = getMessageEdit('noAttendees');
                return;
            }
            registrations.forEach(reg => {
                const row = attendeeListBodyEl.insertRow();
                row.insertCell().textContent = reg.name || '';
                row.insertCell().textContent = reg.email || '';
                row.insertCell().textContent = reg.phone || '';
                row.insertCell().textContent = reg.menuChoice || 'N/A';
                row.insertCell().textContent = reg.registrationDate ? new Date(reg.registrationDate).toLocaleDateString(currentLangEdit === 'fr' ? 'fr-FR' : 'en-US') : 'N/A';
                row.insertCell().textContent = (currentLoadedEventFullData.eventDetails.isPaidEvent && reg.paidStatus) ? (reg.paidStatus === 'yes' || reg.paidStatus === 1 ? getMessageEdit('statusYes') : getMessageEdit('statusNo')) : 'N/A';
            });
        }
        
        function renderWaitlist(waitlist = []) {
            waitlistManagementSectionEl.style.display = 'block';
            waitlistCountEl.textContent = waitlist.length;
            waitlistBodyEl.innerHTML = '';
            if (waitlist.length === 0) {
                const tr = waitlistBodyEl.insertRow();
                const td = tr.insertCell();
                td.colSpan = 4; // Number of columns in waitlist table
                td.textContent = getMessageEdit('waitlistEmpty');
                return;
            }
            waitlist.forEach(item => {
                const row = waitlistBodyEl.insertRow();
                row.insertCell().textContent = item.name || '';
                row.insertCell().textContent = item.email || '';
                row.insertCell().textContent = item.phone || '';
                row.insertCell().textContent = item.waitlistDate ? new Date(item.waitlistDate).toLocaleDateString(currentLangEdit === 'fr' ? 'fr-FR' : 'en-US') : 'N/A';
                 // Add action button for manual registration if needed in future
            });
        }


        // --- CSV Export ---
        function exportAttendeesToCSV(registrations, eventName) {
            if (!registrations || registrations.length === 0) {
                alert(getMessageEdit('noAttendees'));
                return;
            }
            const headers = [getMessageEdit('attendeeName'), getMessageEdit('attendeeEmail'), "Phone", getMessageEdit('attendeeMenu'), "Registration Date", getMessageEdit('attendeePaid')];
            let csvContent = "data:text/csv;charset=utf-8," + headers.join(",") + "\n";

            registrations.forEach(reg => {
                const paidText = (currentLoadedEventFullData.eventDetails.isPaidEvent && reg.paidStatus) ? (reg.paidStatus === 'yes' || reg.paidStatus === 1 ? getMessageEdit('statusYes') : getMessageEdit('statusNo')) : 'N/A';
                const regDate = reg.registrationDate ? new Date(reg.registrationDate).toLocaleDateString(currentLangEdit === 'fr' ? 'fr-FR' : 'en-US') : 'N/A';
                const row = [reg.name, reg.email, reg.phone, reg.menuChoice, regDate, paidText];
                // Escape commas in fields
                const escapedRow = row.map(field => `"${String(field || '').replace(/"/g, '""')}"`);
                csvContent += escapedRow.join(",") + "\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            const safeEventName = eventName.replace(/[^a-z0-9]/gi, '_').toLowerCase();
            link.setAttribute("download", `inscriptions_${safeEventName}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        exportCsvButton.addEventListener('click', function() {
            if (currentLoadedEventFullData && currentLoadedEventFullData.registrations) {
                exportAttendeesToCSV(currentLoadedEventFullData.registrations, currentLoadedEventFullData.eventDetails.eventName);
            } else {
                 alert(getMessageEdit('noDataToExport', currentLangEdit) || "No data to export.");
            }
        });


        // --- Authentication Form Submission ---
        authEventForm.addEventListener('submit', async function(event) {
            event.preventDefault(); clearMessageInline();
            const eventId = this.elements.authEventId.value.trim();
            const password = this.elements.authAdminPassword.value;
            const submitButton = this.querySelector('button[type="submit"]');
            const originalButtonHTML = submitButton.innerHTML;

            if (!eventId) { displayMessageInline(getMessageEdit('eventIdRequired'), 'error'); return; }
            if (!password) { displayMessageInline(getMessageEdit('passwordRequired'), 'error'); return; }

            submitButton.disabled = true; submitButton.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${(currentLangEdit === 'fr' ? 'Chargement...' : 'Loading...')}`;
            
            try {
                // Worker expects POST /api/events/:id/admin for auth and fetching full data
                const response = await fetch(`${WORKER_BASE_URL}/${eventId}/admin`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ adminPassword: password })
                });
                const result = await response.json();
                if (response.ok && result.success && result.eventDetails) { // Expecting { success: true, eventDetails: {...}, registrations: [...], waitlist: [...] }
                    currentAuthenticatedPassword = password;
                    currentlyEditingEventId = eventId;
                    currentLoadedEventFullData = result; // Store the whole payload

                    populateEditForm(result.eventDetails);
                    renderDashboard(result.eventDetails, result.registrations);
                    renderAttendeeList(result.registrations);
                    if(result.eventDetails.enableWaitlist){
                        renderWaitlist(result.waitlist);
                    } else {
                        waitlistManagementSectionEl.style.display = 'none';
                    }

                    authSection.style.display = 'none';
                    eventDashboardAndEditSection.style.display = 'block'; // Show the main content area
                    displayMessageInline(getMessageEdit('eventLoaded'), 'success');
                    authEventForm.reset();
                } else {
                    displayMessageInline(result.error || getMessageEdit('authError'), 'error');
                }
            } catch (e) {
                console.error("Auth fetch error:", e);
                displayMessageInline(getMessageEdit('apiError') + `: ${e.message}`, 'error');
            } finally {
                submitButton.disabled = false; submitButton.innerHTML = originalButtonHTML;
            }
        });

        // --- Edit Event Form Submission (Save Changes) ---
        editEventForm.addEventListener('submit', async function(event) {
            event.preventDefault(); clearMessageInline();
            const submitButton = this.querySelector('button[type="submit"]');
            const originalButtonHTML = submitButton.innerHTML;

            if (!validateDatesEdit() || !this.checkValidity()) {
                displayMessageInline(getMessageEdit('formErrors'), 'error');
                const firstInvalidField = this.querySelector(':invalid:not(fieldset)');
                if (firstInvalidField) firstInvalidField.focus();
                return;
            }

            const eventId = document.getElementById('editingEventId').value;
            if (!eventId || !currentAuthenticatedPassword) { displayMessageInline("Erreur: Session invalide.", 'error'); return; }

            const formData = new FormData(this);
            const eventDataToUpdate = { menuNames: [] }; // Initialize menuNames as an array
            formData.forEach((value, key) => {
                if (key.startsWith('menuName')) {
                    eventDataToUpdate.menuNames.push(value);
                } else if (key === 'isPaidEvent' || key === 'enableWaitlist') {
                    eventDataToUpdate[key] = true;
                } else if (key !== 'editingEventId') { // Exclude hidden event ID from payload to update
                    eventDataToUpdate[key] = value;
                }
            });
             if (!formData.has('isPaidEvent')) eventDataToUpdate.isPaidEvent = false;
             if (!formData.has('enableWaitlist')) eventDataToUpdate.enableWaitlist = false;


            submitButton.disabled = true; submitButton.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${(currentLangEdit === 'fr' ? 'Sauvegarde...' : 'Saving...')}`;
            try {
                const response = await fetch(`${WORKER_BASE_URL}/${eventId}`, {
                    method: 'PUT', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ eventData: eventDataToUpdate, adminPassword: currentAuthenticatedPassword })
                });
                const result = await response.json();
                if (response.ok && result.success) {
                    displayMessageInline(getMessageEdit('changesSaved'), 'success');
                    // Optionally re-fetch and re-render if capacity changed significantly
                    // For now, we assume the form reflects the saved state.
                    currentLoadedEventFullData.eventDetails = {...currentLoadedEventFullData.eventDetails, ...eventDataToUpdate}; // Optimistic update
                    loadedEventNameDisplay.textContent = eventDataToUpdate.eventName; // Update title
                    renderDashboard(currentLoadedEventFullData.eventDetails, currentLoadedEventFullData.registrations); // Re-render dashboard
                } else {
                    displayMessageInline(result.error || getMessageEdit('apiError'), 'error');
                }
            } catch (e) {
                console.error("Update fetch error:", e);
                displayMessageInline(getMessageEdit('apiError') + `: ${e.message}`, 'error');
            } finally {
                submitButton.disabled = false; submitButton.innerHTML = originalButtonHTML;
            }
        });

        // --- Delete Event ---
        deleteEventButton.addEventListener('click', async function() { /* ... (same as before, ensure to reset currentLoadedEventFullData) ... */
            clearMessageInline();
            const eventId = document.getElementById('editingEventId').value;
            if (!eventId || !currentAuthenticatedPassword) { displayMessageInline("Erreur: Session invalide.", 'error'); return; }
            if (confirm(getMessageEdit('confirmDelete'))) {
                const originalButtonHTML = this.innerHTML; this.disabled = true; this.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${(currentLangEdit === 'fr' ? 'Suppression...' : 'Deleting...')}`;
                try {
                    const response = await fetch(`${WORKER_BASE_URL}/${eventId}`, {
                        method: 'DELETE', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ adminPassword: currentAuthenticatedPassword })
                    });
                    const result = await response.json();
                    if (response.ok && result.success) {
                        displayMessageInline(getMessageEdit('eventDeleted'), 'success');
                        eventDashboardAndEditSection.style.display = 'none';
                        authSection.style.display = 'block'; authEventForm.reset();
                        currentAuthenticatedPassword = null; currentlyEditingEventId = null; currentLoadedEventFullData = null;
                        loadedEventNameDisplay.textContent = "";
                    } else { displayMessageInline(result.error || getMessageEdit('apiError'), 'error'); }
                } catch (e) { console.error("Delete fetch error:", e); displayMessageInline(getMessageEdit('apiError') + `: ${e.message}`, 'error');
                } finally { this.disabled = false; this.innerHTML = originalButtonHTML; }
            }
        });
        
        // --- Cancel Edit ---
        cancelEditButton.addEventListener('click', function() { /* ... (same, ensure to reset currentLoadedEventFullData) ... */
            clearMessageInline();
            eventDashboardAndEditSection.style.display = 'none';
            authSection.style.display = 'block'; authEventForm.reset();
            currentAuthenticatedPassword = null; currentlyEditingEventId = null; currentLoadedEventFullData = null;
            loadedEventNameDisplay.textContent = "";
        });

        // --- Initial Page Setup ---
        queryTranslatableItemsEdit();
        const preferredLangEdit = detectLanguagePreferenceEdit();
        updateUIForLanguageEdit(preferredLangEdit);
        
        // Autofill Event ID from URL if present
        const urlParams = new URLSearchParams(window.location.search);
        const eventIdFromUrl = urlParams.get('id');
        if (eventIdFromUrl) {
            document.getElementById('authEventId').value = eventIdFromUrl;
        }


        console.log("edit-event.html inline JS with dashboard features loaded.");
        // hf.js loading
        if (typeof createHeader === "function" && typeof createFooter === "function") {
            createHeader('app-header', currentLangEdit); createFooter('app-footer', currentLangEdit);
        } else if (typeof loadHf === "function") { loadHf(currentLangEdit);
        } else { /* fallback for hf.js as in create-event */
             const headerDiv = document.getElementById('app-header'); const footerDiv = document.getElementById('app-footer');
             if(headerDiv && !headerDiv.innerHTML.trim()) headerDiv.innerHTML = `<div class="header-container"><div class="logo"><a href="index.html">MonRdvFacile</a></div><nav class="main-nav"><ul><li><a href="index.html">Accueil</a></li></ul></nav><button class="mobile-nav-toggle"><i class="fas fa-bars"></i></button></div>`;
             if(footerDiv && !footerDiv.innerHTML.trim()) footerDiv.innerHTML = `<div class="footer-container"><p>&copy; ${new Date().getFullYear()} MonRdvFacile</p></div>`;
        }
        // Re-query and update language after hf.js might have added elements
        setTimeout(() => { queryTranslatableItemsEdit(); updateUIForLanguageEdit(currentLangEdit); }, 200);


    });
    </script>
</body>
</html>
